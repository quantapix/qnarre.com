<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A quick narrative analyzer for &lsquo;bipolar&rsquo; text"><meta name=author content="Qnarre - Software is our passion"><meta name=generator content="Hugo 0.99.0"><meta name=docsearch:language content="en"><meta name=docsearch:version content="0.1.0"><title>Trackable - A Pervasive Persistence Infrastructure Â· Qnarre</title><link rel=canonical href=https://qnarre.com/tech/trackable/><link href=../../css/bootstrap.min.css rel=stylesheet><link href=../../css/style.css rel=stylesheet><link rel=apple-touch-icon href=../../img/favs/apple-touch-icon.png sizes=180x180><link rel=icon href=../../img/favs/favicon-32x32.png sizes=32x32 type=image/png><link rel=icon href=../../img/favs/favicon-16x16.png sizes=16x16 type=image/png><link rel=manifest href=../../img/favs/manifest.json><link rel=mask-icon href=../../img/favs/safari-pinned-tab color=#7952b3><link rel=icon href=../../img/favs/favicon.ico><meta name=theme-color content="#7952b3"></head><body><div class="skippy visually-hidden-focusable overflow-hidden"><div class=container-xl><a class="d-inline-flex p-2 m-1" href=#content>Skip to content</a></div></div><header class="navbar navbar-expand-md navbar-dark qal-navbar"><nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-2" href=../../><svg xmlns="http://www.w3.org/2000/svg" width="40" height="32" class="d-block my-1" viewBox="0 0 118 94" role="img"><title>Silcrow</title><path d="m67.476567 58.848956q2.916668 2.114585 4.375002 4.812503t1.458334 5.942711q0 5.250002-4.520836 8.421879-4.520835 3.208335-10.60938 3.208335-5.541669.0-9.406254-2.552085-3.864586-2.552084-3.864586-6.270836.0-2.151043 1.421876-3.500002 1.421876-1.3125 3.208335-1.3125 1.932293.0 3.026043 1.09375 1.093751 1.130209 1.786459 3.609377.911459 3.09896 2.296876 3.97396 1.385418.911459 3.208335.911459 2.187501.0 3.75521-1.239584t1.567709-3.026043q0-1.458334-1.020833-3.135418-1.057293-1.640626-6.708337-5.468753-6.526045-4.375002-9.369796-6.781253-2.843751-2.44271-4.375002-5.322919-1.531251-2.916669-1.531251-6.19792.0-3.09896 1.348959-5.432294 1.385417-2.333335 3.208335-3.427085 1.822918-1.130209 4.302085-1.713543-3.098959-2.260418-4.666668-4.921877-1.56771-2.66146-1.56771-5.76042.0-5.322919 4.484378-8.640629 4.484377-3.354168 10.901046-3.354168 5.395836.0 9.333338 2.515626t3.937502 6.088545q0 2.114584-1.494792 3.463543-1.494793 1.348959-3.427085 1.348959-1.895834.0-2.843752-.984375-.947917-1.020834-1.859376-3.718752-.838542-2.552085-2.078125-3.609377-1.239584-1.057292-3.463544-1.057292-2.296876.0-3.937502 1.276042-1.604167 1.276043-1.604167 3.062502.0 2.041667 1.567709 3.682293 1.531251 1.640626 7.473962 5.432294 5.578128 3.572919 8.239587 5.76042 2.697918 2.151043 4.229169 5.140627 1.567709 2.989585 1.567709 6.453128.0 4.411461-2.078126 7.218754-2.078126 2.807293-6.270836 4.010418zm1.166667-7.000003q0-3.682293-6.234378-8.531254-6.19792-4.885419-9.187505-4.885419-1.385417.0-2.661459 1.09375-1.239584 1.057293-1.239584 2.515627.0 3.463543 6.307295 8.421879 6.343753 4.958335 9.260421 4.958335 1.53125.0 2.625001-1.057292 1.130209-1.057292 1.130209-2.515626z" fill="#fff"/></svg></a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#qalNavbar aria-controls=qalNavbar aria-expanded=false aria-label="Toggle navigation"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" class="bi" fill="currentcolor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 11.5A.5.5.0 013 11h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5zm0-4A.5.5.0 013 7h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5zm0-4A.5.5.0 013 3h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5z"/></svg></button><div class="collapse navbar-collapse" id=qalNavbar><hr class="d-md-none text-white-50"><ul class="navbar-nav flex-row flex-wrap qal-navbar-nav"><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../>Qnarre</a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../modeling/>Modeling</a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../semantics/>Semantics</a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../analytics/>Analytics</a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../reports/>Reports</a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../story/>The Story</a></li></ul><hr class="d-md-none text-white-50"><ul class="navbar-nav flex-row flex-wrap ms-md-auto"><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=https://twitter.com/ikifor target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" class="navbar-nav-svg d-inline-block align-text-top" viewBox="0 0 512 416.32" role="img"><title>Twitter</title><path fill="currentcolor" d="M160.83 416.32c193.2.0 298.92-160.22 298.92-298.92.0-4.51.0-9-.2-13.52A214 214 0 00512 49.38a212.93 212.93.0 01-60.44 16.6 105.7 105.7.0 0046.3-58.19 209 209 0 01-66.79 25.37 105.09 105.09.0 00-181.73 71.91 116.12 116.12.0 002.66 24c-87.28-4.3-164.73-46.3-216.56-109.82A105.48 105.48.0 0068 159.6a106.27 106.27.0 01-47.53-13.11v1.43a105.28 105.28.0 0084.21 103.06 105.67 105.67.0 01-47.33 1.84 105.06 105.06.0 0098.14 72.94A210.72 210.72.0 0125 370.84a202.17 202.17.0 01-25-1.43 298.85 298.85.0 00160.83 46.92"/></svg><small class="d-md-none ms-2">Twitter</small></a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=https://github.com/quantapix target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" class="navbar-nav-svg d-inline-block align-text-top" viewBox="0 0 512 499.36" role="img"><title>GitHub</title><path fill="currentcolor" fill-rule="evenodd" d="M256 0C114.64.0.0 114.61.0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34.0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49.0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75.0.0 21.49-6.88 70.4 26.24a242.65 242.65.0 01128.18.0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69.0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41.0 34.22-.31 61.83-.31 70.23.0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37.0 256 0z"/></svg><small class="d-md-none ms-2">GitHub</small></a></li></ul><a class="btn btn-qal-download d-lg-inline-block my-2 my-md-0 ms-md-3" href=https://femfas.net/>femfas.net</a></div></nav></header><div class="container-xxl my-md-4 qal-layout"><aside class=qal-sidebar><nav class="collapse qal-links" id=qal-docs-nav aria-label="Nav links"><ul class="list-unstyled mb-0 py-3 pt-md-1"><li class=mb-1><button class="btn d-inline-flex align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#modeling-collapse aria-expanded=false>
Modeling</button><div class=collapse id=modeling-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../modeling/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../modeling/simulation class="d-inline-flex align-items-center rounded">Judicial Simulation</a></li><li><a href=../../modeling/concepts class="d-inline-flex align-items-center rounded">Conceptual Model</a></li><li><a href=../../modeling/report class="d-inline-flex align-items-center rounded">Sample Report</a></li></ul></div></li><li class=mb-1><button class="btn d-inline-flex align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#semantics-collapse aria-expanded=false>
Semantics</button><div class=collapse id=semantics-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../semantics/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../semantics/simulation class="d-inline-flex align-items-center rounded">Judicial Simulation</a></li><li><a href=../../semantics/concepts class="d-inline-flex align-items-center rounded">Conceptual Model</a></li></ul></div></li><li class=mb-1><button class="btn d-inline-flex align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#analytics-collapse aria-expanded=false>
Analytics</button><div class=collapse id=analytics-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../analytics/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../analytics/prepare class="d-inline-flex align-items-center rounded">Preparing Documents</a></li><li><a href=../../analytics/extract class="d-inline-flex align-items-center rounded">Extracting Narratives</a></li><li><a href=../../analytics/output class="d-inline-flex align-items-center rounded">Standardized Output</a></li><li><a href=../../analytics/graph class="d-inline-flex align-items-center rounded">Conflict Graph</a></li><li><a href=../../analytics/analyze class="d-inline-flex align-items-center rounded">Irrefutable Analytics</a></li></ul></div></li><li class=mb-1><button class="btn d-inline-flex align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#reports-collapse aria-expanded=false>
Reports</button><div class=collapse id=reports-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../reports/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../reports/prepare class="d-inline-flex align-items-center rounded">Generating Reports</a></li></ul></div></li><li class=mb-1><button class="btn d-inline-flex align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#story-collapse aria-expanded=false>
The Story</button><div class=collapse id=story-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../story/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../story/about class="d-inline-flex align-items-center rounded">About</a></li><li><a href=../../story/blog class="d-inline-flex align-items-center rounded">Blog</a></li></ul></div></li><li class=mb-1><button class="btn d-inline-flex align-items-center rounded" data-bs-toggle=collapse data-bs-target=#tech-collapse aria-expanded=true aria-current=true>
Available Tech</button><div class="collapse show" id=tech-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../tech/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../tech/trackable class="d-inline-flex align-items-center rounded active" aria-current=page>Trackable Persistence</a></li><li><a href=../../tech/gpus class="d-inline-flex align-items-center rounded">Many Smaller GPUs</a></li><li><a href=../../tech/dataset class="d-inline-flex align-items-center rounded">Datasets</a></li><li><a href=../../tech/masking class="d-inline-flex align-items-center rounded">Unified Masking</a></li><li><a href=../../tech/ragged class="d-inline-flex align-items-center rounded">Ragged Tensors</a></li><li><a href=../../tech/layers class="d-inline-flex align-items-center rounded">Layers Simplified</a></li><li><a href=../../tech/custom class="d-inline-flex align-items-center rounded">Custom Layers</a></li><li><a href=../../tech/autograph class="d-inline-flex align-items-center rounded">Autograph</a></li><li><a href=../../tech/metrics class="d-inline-flex align-items-center rounded">Modular Metrics</a></li><li><a href=../../tech/callbacks class="d-inline-flex align-items-center rounded">Extended Callbacks</a></li></ul></div></li></ul></nav></aside><main class="qal-main order-1"><div class="qal-intro ps-lg-4"><div class="d-md-flex flex-md-row align-items-center justify-content-between"><h1 class=qal-title id=content>Trackable - A Pervasive Persistence Infrastructure</h1></div><p class=qal-lead></p></div><div class="qal-toc mt-4 mb-5 my-md-0 ps-xl-3 mb-lg-5 text-muted"><strong class="d-block h6 my-2 pb-2 border-bottom">On this page</strong><nav id=TableOfContents><ul><li><a href=#private-trackable-object>Private Trackable object</a></li><li><a href=#pythonic-autotrackable>Pythonic AutoTrackable</a></li><li><a href=#layered-objects-taxonomy>Layered objects taxonomy</a></li><li><a href=#full-python-attribute-mechanism>Full Python attribute mechanism</a></li><li><a href=#aggregating-variables>Aggregating variables</a></li><li><a href=#sharing-variables>Sharing variables</a></li><li><a href=#encapsulating-variables>Encapsulating variables</a></li><li><a href=#modules-and-keras-layers>Modules and Keras layers</a></li><li><a href=#a-most-simple-model>A most simple model</a></li><li><a href=#new-pythonic-autograph>New Pythonic &lsquo;autograph&rsquo;</a></li></ul></nav></div><div class="qal-content ps-lg-4"><p>Training in TensorFlow means continually adjusting collections of values stored as <code>tensors</code> in objects called <code>variables</code>.</p><p>The persistence of these variables, from one training session to the next, is critical for improving on the already achieved, but otherwise long-running results.</p><p>A new system-wide pervasive <code>trackable</code> architecture now provides just such a persistence infrastructure. Instead of the old name-based hierarchy, the new design applies a topological, &ldquo;layered objects&rdquo; naming scheme.</p><p>In this first blog, we explore some of the key aspects of this architecture. We start with a high-level view and then we gradually build from the simple base classes to the more useful Keras <code>layers</code>.</p><p>Our objective is to arrive at a training model representable by the <a href=generated/images/tech/trackable.pdf>graph</a> and <a href=https://github.com/quantapix/qnarre/blob/master/docs/advanced_tf/trackable.ipynb>runnable example</a>.</p><p>We first need to prep our environment to run any meaningful code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tensorflow</span> <span class=k>as</span> <span class=nn>tf</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tensorflow.python.training.tracking</span> <span class=kn>import</span> <span class=n>base</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tensorflow.python.training.tracking</span> <span class=kn>import</span> <span class=n>tracking</span>
</span></span></code></pre></div><p>The actual persistence of training data, the <code>weights</code>, is ultimately realized through explicit <code>Checkpoint</code> objects.</p><p>As the number of such representations grows, saved as efficiently encoded versioned files, <code>CheckpointManager</code>s help with keeping track (see TF docs for full functionality).</p><h2 id=private-trackable-object>Private Trackable object</h2><p>We present a simple scenario for persisting (saving and restoring) a single-valued variable encapsulated by a <code>Trackable</code> object as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>trackable</span><span class=p>(</span><span class=n>tr1</span><span class=p>,</span> <span class=n>v</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>Checkpoint</span><span class=p>(</span><span class=n>tr1</span><span class=o>=</span><span class=n>tr1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>CheckpointManager</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=s1>&#39;/tmp/q/trackable&#39;</span><span class=p>,</span> <span class=n>max_to_keep</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=n>latest_checkpoint</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=o>.</span><span class=n>restore</span><span class=p>(</span><span class=n>p</span><span class=p>)</span><span class=o>.</span><span class=n>expect_partial</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;restored from: </span><span class=si>{</span><span class=n>p</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;others are: </span><span class=si>{</span><span class=n>m</span><span class=o>.</span><span class=n>checkpoints</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;start from scratch&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;value before: </span><span class=si>{</span><span class=n>v</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>v</span><span class=o>.</span><span class=n>assign_add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</span></span></code></pre></div><p>Using the above function, our 3 iterations of incrementing the single-valued <code>int</code> variable and keeping track of the <code>Checkpoint</code> files result in:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>tr1</span> <span class=o>=</span> <span class=n>base</span><span class=o>.</span><span class=n>Trackable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>v</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tr1</span><span class=o>.</span><span class=n>_track_trackable</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;tr1_v&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>trackable</span><span class=p>(</span><span class=n>tr1</span><span class=p>,</span> <span class=n>v</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  start from scratch
</span></span><span class=line><span class=cl>  value before: <span class=m>1</span>
</span></span><span class=line><span class=cl>  restored from: /tmp/q/trackable/ckpt-1
</span></span><span class=line><span class=cl>  others are: <span class=o>[</span><span class=s1>&#39;/tmp/q/trackable/ckpt-1&#39;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>  value before: <span class=m>2</span>
</span></span><span class=line><span class=cl>  restored from: /tmp/q/trackable/ckpt-2
</span></span><span class=line><span class=cl>  others are: <span class=o>[</span><span class=s1>&#39;/tmp/q/trackable/ckpt-1&#39;</span>, <span class=s1>&#39;/tmp/q/trackable/ckpt-2&#39;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>  value before: <span class=m>3</span>
</span></span></code></pre></div><p>While the above snippet is fully functional, the extensive boiler-plate code becomes an unnecessary hassle when implementing even slightly more complex schemes.</p><p>Also note that we used a private, undocumented and non-API method to make our code work. A more convenient &ldquo;auto-tracking&rdquo; functionality is needed.</p><h2 id=pythonic-autotrackable>Pythonic AutoTrackable</h2><p>The native Python attribute mechanism conveniently provides a framework to satisfy such needs as we&rsquo;ll see in a moment.</p><p>In preparation, our slightly adjusted printing function is now as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>autotrackable</span><span class=p>(</span><span class=n>tr2</span><span class=p>,</span> <span class=n>tracked</span><span class=p>,</span> <span class=n>untracked</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>Checkpoint</span><span class=p>(</span><span class=n>tr2</span><span class=o>=</span><span class=n>tr2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>CheckpointManager</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=s1>&#39;/tmp/q/trackable&#39;</span><span class=p>,</span> <span class=n>max_to_keep</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=n>latest_checkpoint</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=o>.</span><span class=n>restore</span><span class=p>(</span><span class=n>p</span><span class=p>)</span><span class=o>.</span><span class=n>expect_partial</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;restored from: </span><span class=si>{</span><span class=n>p</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;values before: </span><span class=si>{</span><span class=n>tracked</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>, </span><span class=si>{</span><span class=n>untracked</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>tracked</span><span class=o>.</span><span class=n>assign_add</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;value as saved: </span><span class=si>{</span><span class=n>tracked</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>And here is our use of an <code>AutoTrackable</code> object holding onto 2 single-valued variables.</p><p>Notice the intuitive <code>tr2.v = tracked</code> assignment, as this is where the entire &ldquo;trackable&rdquo; scheme is triggered.</p><p>Just in case we want to avoid the default functionality, we can turn off auto-tracking as well:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>tr2</span> <span class=o>=</span> <span class=n>tracking</span><span class=o>.</span><span class=n>AutoTrackable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>tracked</span><span class=p>,</span> <span class=n>untracked</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=mi>1000</span><span class=p>),</span> <span class=n>tf</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tr2</span><span class=o>.</span><span class=n>v</span> <span class=o>=</span> <span class=n>tracked</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>base</span><span class=o>.</span><span class=n>no_automatic_dependency_tracking_scope</span><span class=p>(</span><span class=n>tr2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>tr2</span><span class=o>.</span><span class=n>untracked</span> <span class=o>=</span> <span class=n>untracked</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>autotrackable</span><span class=p>(</span><span class=n>tr2</span><span class=p>,</span> <span class=n>tracked</span><span class=p>,</span> <span class=n>untracked</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  restored from: /tmp/q/trackable/ckpt-3
</span></span><span class=line><span class=cl>  values before: 1000, <span class=m>0</span>
</span></span><span class=line><span class=cl>  value as saved: <span class=m>2000</span>
</span></span><span class=line><span class=cl>  restored from: /tmp/q/trackable/ckpt-4
</span></span><span class=line><span class=cl>  values before: 2000, <span class=m>0</span>
</span></span><span class=line><span class=cl>  value as saved: <span class=m>3000</span>
</span></span></code></pre></div><p>Employing the native Python attribute mechanism and assignment operator allows us to reliably &ldquo;auto track&rdquo; hundreds or thousands of training variables.</p><h2 id=layered-objects-taxonomy>Layered objects taxonomy</h2><p>Moreover, a consistent hierarchical &ldquo;layered objects&rdquo; naming scheme emerges, without the need for explicit, string-based names.</p><p>For a snapshot view of the &ldquo;topology&rdquo; of our layers, or just a simple inventory of our variables, we can use the helper functions provided by TF:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>listing</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>Checkpoint</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>CheckpointManager</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=s1>&#39;/tmp/q/trackable&#39;</span><span class=p>,</span> <span class=n>max_to_keep</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=n>latest_checkpoint</span>
</span></span><span class=line><span class=cl>    <span class=n>vs</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>list_variables</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;names and shapes list: </span><span class=si>{</span><span class=n>vs</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>vs</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>v</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>load_variable</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;loaded value: </span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s1> for name: </span><span class=si>{</span><span class=n>n</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>load_checkpoint</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ts</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>get_variable_to_dtype_map</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ss</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>get_variable_to_shape_map</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;checkpoint types: </span><span class=si>{</span><span class=n>ts</span><span class=si>}</span><span class=s1> and shapes: </span><span class=si>{</span><span class=n>ss</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>Looking at the result of calling our function, we can quickly grasp the otherwise simple pattern of hierarchical naming convention employed by the architecture:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>listing</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  names and shapes list: <span class=o>[(</span><span class=s1>&#39;_CHECKPOINTABLE_OBJECT_GRAPH&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;save_counter/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;tr2/v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])]</span>
</span></span><span class=line><span class=cl>  loaded value: <span class=m>3000</span> <span class=k>for</span> name: tr2/v/.ATTRIBUTES/VARIABLE_VALUE
</span></span><span class=line><span class=cl>  checkpoint types: <span class=o>{</span><span class=s1>&#39;tr2/v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>: tf.int32, <span class=s1>&#39;_CHECKPOINTABLE_OBJECT_GRAPH&#39;</span>: tf.string, <span class=s1>&#39;save_counter/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>: tf.int64<span class=o>}</span> and shapes: <span class=o>{</span><span class=s1>&#39;tr2/v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>: <span class=o>[]</span>, <span class=s1>&#39;_CHECKPOINTABLE_OBJECT_GRAPH&#39;</span>: <span class=o>[]</span>, <span class=s1>&#39;save_counter/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>: <span class=o>[]}</span>
</span></span></code></pre></div><h2 id=full-python-attribute-mechanism>Full Python attribute mechanism</h2><p>Any type of variable management system that allows creating variables must also support deleting them.</p><p>The familiar native Python attribute mechanism&rsquo;s <code>del</code> operation is used to delete a variable from the hierarchy, just as shown below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>deleting</span><span class=p>(</span><span class=n>tr2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>Checkpoint</span><span class=p>(</span><span class=n>tr2</span><span class=o>=</span><span class=n>tr2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>CheckpointManager</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=s1>&#39;/tmp/q/trackable&#39;</span><span class=p>,</span> <span class=n>max_to_keep</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=o>.</span><span class=n>restore</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>latest_checkpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=o>.</span><span class=n>tr2</span><span class=o>.</span><span class=n>deleted</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>vs</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>list_variables</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>latest_checkpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;list deleted: </span><span class=si>{</span><span class=n>vs</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>del</span> <span class=n>c</span><span class=o>.</span><span class=n>tr2</span><span class=o>.</span><span class=n>deleted</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>vs</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>list_variables</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>latest_checkpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;deleted IS DELETED: </span><span class=si>{</span><span class=n>vs</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>And here are the results of calling our <code>deleting</code> function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>deleting</span><span class=p>(</span><span class=n>tr2</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  list deleted: <span class=o>[(</span><span class=s1>&#39;_CHECKPOINTABLE_OBJECT_GRAPH&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;save_counter/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;tr2/deleted/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;tr2/v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])]</span>
</span></span><span class=line><span class=cl>  deleted IS DELETED: <span class=o>[(</span><span class=s1>&#39;_CHECKPOINTABLE_OBJECT_GRAPH&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;save_counter/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;tr2/v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])]</span>
</span></span></code></pre></div><h2 id=aggregating-variables>Aggregating variables</h2><p>Variable management also means possibly aggregating variables into various containers.</p><p>Intuitive Python <code>list</code> and <code>dict</code> structures can be transparently employed through the <code>trackable</code> mechanism.</p><p>Using our below-modified function to print our variables in our `containers':</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>containers</span><span class=p>(</span><span class=n>tr3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>Checkpoint</span><span class=p>(</span><span class=n>tr3</span><span class=o>=</span><span class=n>tr3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>CheckpointManager</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=s1>&#39;/tmp/q/trackable&#39;</span><span class=p>,</span> <span class=n>max_to_keep</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>vs</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>list_variables</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>latest_checkpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;containers: </span><span class=si>{</span><span class=n>vs</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>Just as mentioned above, we can intuitively collect variables into either <code>list</code>s or <code>dict</code>s.</p><p>And the patterns used for naming the thus aggregated variables are just as expected:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>tr3</span> <span class=o>=</span> <span class=n>tracking</span><span class=o>.</span><span class=n>AutoTrackable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>br1</span> <span class=o>=</span> <span class=n>tracking</span><span class=o>.</span><span class=n>AutoTrackable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>br1</span><span class=o>.</span><span class=n>v</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>br2</span> <span class=o>=</span> <span class=n>tracking</span><span class=o>.</span><span class=n>AutoTrackable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>br2</span><span class=o>.</span><span class=n>v</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tr3</span><span class=o>.</span><span class=n>br_list</span> <span class=o>=</span> <span class=p>[</span><span class=n>br1</span><span class=p>,</span> <span class=n>br2</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>br3</span> <span class=o>=</span> <span class=n>tracking</span><span class=o>.</span><span class=n>AutoTrackable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>br3</span><span class=o>.</span><span class=n>v</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tr3</span><span class=o>.</span><span class=n>br_dict</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;br3&#39;</span><span class=p>:</span> <span class=n>br3</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>containers</span><span class=p>(</span><span class=n>tr3</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  containers: <span class=o>[(</span><span class=s1>&#39;_CHECKPOINTABLE_OBJECT_GRAPH&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;save_counter/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;tr3/br_dict/br3/v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;tr3/br_list/0/v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;tr3/br_list/1/v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])]</span>
</span></span></code></pre></div><h2 id=sharing-variables>Sharing variables</h2><p>Neural networks rely on sharing persisted trainable weights, TF variables in our case, to express interdependencies.</p><p>Variable sharing was ad-hoc, only name-based and with a global scope before.</p><p>As Python has extensive native support for managing easily sharable references to its objects, this fundamental problem gets an intuitive solution with the new trackable architecture.</p><p>As expected, sharing variables now is natural and also safe, as it uses references instead of error-prone strings:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>sharing</span><span class=p>(</span><span class=n>tr3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>Checkpoint</span><span class=p>(</span><span class=n>tr3</span><span class=o>=</span><span class=n>tr3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>CheckpointManager</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=s1>&#39;/tmp/q/trackable&#39;</span><span class=p>,</span> <span class=n>max_to_keep</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=o>.</span><span class=n>restore</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>latest_checkpoint</span><span class=p>)</span><span class=o>.</span><span class=n>assert_consumed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>v1</span> <span class=o>=</span> <span class=n>tr3</span><span class=o>.</span><span class=n>br_list</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>v</span>
</span></span><span class=line><span class=cl>    <span class=n>v2</span> <span class=o>=</span> <span class=n>tr3</span><span class=o>.</span><span class=n>br_list</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>v</span>
</span></span><span class=line><span class=cl>    <span class=n>vd1</span> <span class=o>=</span> <span class=n>tr3</span><span class=o>.</span><span class=n>br_dict</span><span class=p>[</span><span class=s1>&#39;br1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>v</span>
</span></span><span class=line><span class=cl>    <span class=n>vd2</span> <span class=o>=</span> <span class=n>tr3</span><span class=o>.</span><span class=n>br_dict</span><span class=p>[</span><span class=s1>&#39;br2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>v</span>
</span></span><span class=line><span class=cl>    <span class=n>vd3</span> <span class=o>=</span> <span class=n>tr3</span><span class=o>.</span><span class=n>br_dict</span><span class=p>[</span><span class=s1>&#39;br3&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>v</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;all fives: </span><span class=si>{</span><span class=n>v1</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>, </span><span class=si>{</span><span class=n>v2</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>, </span><span class=si>{</span><span class=n>vd3</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;shared too: </span><span class=si>{</span><span class=n>vd1</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>, </span><span class=si>{</span><span class=n>vd2</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>v1</span><span class=o>.</span><span class=n>assign_add</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>v2</span><span class=o>.</span><span class=n>assign_add</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>vd3</span><span class=o>.</span><span class=n>assign_add</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>vs</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>list_variables</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>latest_checkpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;shared not repeated: </span><span class=si>{</span><span class=n>vs</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>v1</span><span class=o>.</span><span class=n>assign_add</span><span class=p>(</span><span class=o>-</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>v2</span><span class=o>.</span><span class=n>assign_add</span><span class=p>(</span><span class=o>-</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>vd3</span><span class=o>.</span><span class=n>assign_add</span><span class=p>(</span><span class=o>-</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;all zeros: </span><span class=si>{</span><span class=n>v1</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>, </span><span class=si>{</span><span class=n>v2</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>, </span><span class=si>{</span><span class=n>vd3</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;shared too: </span><span class=si>{</span><span class=n>vd1</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>, </span><span class=si>{</span><span class=n>vd2</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c2</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>Checkpoint</span><span class=p>(</span><span class=n>tr3</span><span class=o>=</span><span class=n>tr3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>CheckpointManager</span><span class=p>(</span><span class=n>c2</span><span class=p>,</span> <span class=s1>&#39;/tmp/q/trackable&#39;</span><span class=p>,</span> <span class=n>max_to_keep</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c2</span><span class=o>.</span><span class=n>restore</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>latest_checkpoint</span><span class=p>)</span><span class=o>.</span><span class=n>assert_consumed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;all tens: </span><span class=si>{</span><span class=n>v1</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>, </span><span class=si>{</span><span class=n>v2</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>, </span><span class=si>{</span><span class=n>vd3</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;shared too: </span><span class=si>{</span><span class=n>vd1</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>, </span><span class=si>{</span><span class=n>vd2</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>Persisted shared variables are not duplicated in checkpoints. And when checkpoints are restored or reloaded, the in-memory sharing of variables is also re-established.</p><p>Updates to our shared variables can be easily verified just as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>tr3</span><span class=o>.</span><span class=n>br_dict</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;br1&#39;</span><span class=p>:</span> <span class=n>br1</span><span class=p>,</span> <span class=s1>&#39;br2&#39;</span><span class=p>:</span> <span class=n>br2</span><span class=p>,</span> <span class=s1>&#39;br3&#39;</span><span class=p>:</span> <span class=n>br3</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>sharing</span><span class=p>(</span><span class=n>tr3</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  all fives: 5, 5, <span class=m>5</span>
</span></span><span class=line><span class=cl>  shared too: 5, <span class=m>5</span>
</span></span><span class=line><span class=cl>  shared not repeated: <span class=o>[(</span><span class=s1>&#39;_CHECKPOINTABLE_OBJECT_GRAPH&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;save_counter/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;tr3/br_dict/br3/v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;tr3/br_list/0/v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;tr3/br_list/1/v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])]</span>
</span></span><span class=line><span class=cl>  all zeros: 0, 0, <span class=m>0</span>
</span></span><span class=line><span class=cl>  shared too: 0, <span class=m>0</span>
</span></span><span class=line><span class=cl>  all tens: 10, 10, <span class=m>10</span>
</span></span><span class=line><span class=cl>  shared too: 10, <span class=m>10</span>
</span></span></code></pre></div><h2 id=encapsulating-variables>Encapsulating variables</h2><p>Variable management also means possible encapsulation.</p><p>The new <code>Module</code> objects build on <code>AutoTrackable</code> to extend Python&rsquo;s familiar <code>class</code>-based encapsulation mechanism.</p><p>The also supported explicit name scoping of modules allows the reuse of module classes, as instances of the same class would need to be generically counted otherwise:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Module</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sub</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>name_scope</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>v</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;m_v&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__str__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;n: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s1>, v: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>v</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>sub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;, s: (</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>sub</span><span class=si>}</span><span class=s1>)&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@tf</span><span class=o>.</span><span class=n>Module</span><span class=o>.</span><span class=n>with_name_scope</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>sub</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>y</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>constant</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>sub</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>math</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>v</span><span class=o>.</span><span class=n>assign</span><span class=p>(</span><span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>y</span>
</span></span></code></pre></div><p>When building hierarchies of modules, TF provided convenience methods also allow for recursively collecting the &ldquo;layered&rdquo; variables. This is essential for computing gradients:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>modules</span><span class=p>(</span><span class=n>mod</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>vs</span> <span class=o>=</span> <span class=p>[</span><span class=n>v</span><span class=o>.</span><span class=n>name</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>mod</span><span class=o>.</span><span class=n>variables</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ms</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span><span class=o>.</span><span class=n>name</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>mod</span><span class=o>.</span><span class=n>submodules</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;mod variables: </span><span class=si>{</span><span class=n>vs</span><span class=si>}</span><span class=s1>, submodules: </span><span class=si>{</span><span class=n>ms</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>Checkpoint</span><span class=p>(</span><span class=n>module</span><span class=o>=</span><span class=n>mod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>CheckpointManager</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=s1>&#39;/tmp/q/trackable&#39;</span><span class=p>,</span> <span class=n>max_to_keep</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>mod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>mod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>mod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>mod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=n>latest_checkpoint</span>
</span></span><span class=line><span class=cl>    <span class=n>vs</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>list_variables</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;containers: </span><span class=si>{</span><span class=n>vs</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=o>.</span><span class=n>restore</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;restored: </span><span class=si>{</span><span class=n>mod</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>With our module class and our handy printing function, we can now build a basic nested hierarchy of 3 layered modules.</p><p>Printing our &ldquo;one branch tree&rdquo; shows both the name-based hierarchy and the Python-object or topological &ldquo;checkpoint&rdquo; hierarchy:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>mod1</span> <span class=o>=</span> <span class=n>Module</span><span class=p>(</span><span class=s1>&#39;m1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mod1</span><span class=o>.</span><span class=n>sub</span> <span class=o>=</span> <span class=n>Module</span><span class=p>(</span><span class=s1>&#39;m2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mod1</span><span class=o>.</span><span class=n>sub</span><span class=o>.</span><span class=n>sub</span> <span class=o>=</span> <span class=n>Module</span><span class=p>(</span><span class=s1>&#39;m3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>modules</span><span class=p>(</span><span class=n>mod1</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  mod variables: <span class=o>[</span><span class=s1>&#39;m1/m_v:0&#39;</span>, <span class=s1>&#39;m2/m_v:0&#39;</span>, <span class=s1>&#39;m3/m_v:0&#39;</span><span class=o>]</span>, submodules: <span class=o>[</span><span class=s1>&#39;m2&#39;</span>, <span class=s1>&#39;m3&#39;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>  n: m1, v: 103, s: <span class=o>(</span>n: m2, v: 102, s: <span class=o>(</span>n: m3, v: 101<span class=o>))</span>
</span></span><span class=line><span class=cl>  n: m1, v: 406, s: <span class=o>(</span>n: m2, v: 303, s: <span class=o>(</span>n: m3, v: 201<span class=o>))</span>
</span></span><span class=line><span class=cl>  containers: <span class=o>[(</span><span class=s1>&#39;_CHECKPOINTABLE_OBJECT_GRAPH&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;module/sub/sub/v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;module/sub/v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;module/v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;save_counter/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])]</span>
</span></span><span class=line><span class=cl>  restored: n: m1, v: 103, s: <span class=o>(</span>n: m2, v: 102, s: <span class=o>(</span>n: m3, v: 101<span class=o>))</span>
</span></span></code></pre></div><p>Keras is the API for consistently reasoning about the interconnected network of components. It also visibly splits the two distinct, building vs. executing, phases of our component &ldquo;graphs&rdquo;.</p><p>The <code>functional</code> Keras, as opposed to either the <code>sequential</code> or the <code>subclassed</code> flavors, has the most pre-packaged features to assist us with our neural networks. We aim to use it throughout our blogs.</p><h2 id=modules-and-keras-layers>Modules and Keras layers</h2><p>Keras <code>layer</code>s, as well-defined encapsulating components, build on the previously used <code>module</code>s to manage variable persistence.</p><p>Hence, the previous <code>module</code>s example is almost identical to the below shown &ldquo;Keras layers&rdquo; version:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Layer</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Layer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sub</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=o>**</span><span class=n>kw</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=o>**</span><span class=n>kw</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sub</span> <span class=o>=</span> <span class=n>sub</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__str__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;n: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s1>, v: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>v</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>sub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;, s: (</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>sub</span><span class=si>}</span><span class=s1>)&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>build</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>input_shape</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>v</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>add_weight</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;l_v&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                 <span class=n>shape</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>                                 <span class=n>dtype</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>int32</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                 <span class=n>initializer</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>ones_initializer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>build</span><span class=p>(</span><span class=n>input_shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>sub</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>y</span> <span class=o>=</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>math</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>v</span><span class=o>.</span><span class=n>assign</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>reduce_sum</span><span class=p>(</span><span class=n>y</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>y</span>
</span></span></code></pre></div><p>And, after adjusting our helper to print the results:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>models</span><span class=p>(</span><span class=n>mod</span><span class=p>,</span> <span class=n>lay</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>mod</span><span class=o>.</span><span class=n>summary</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>vs</span> <span class=o>=</span> <span class=p>[</span><span class=n>v</span><span class=o>.</span><span class=n>name</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>mod</span><span class=o>.</span><span class=n>variables</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ts</span> <span class=o>=</span> <span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>name</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>mod</span><span class=o>.</span><span class=n>trainable_variables</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ms</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span><span class=o>.</span><span class=n>name</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>mod</span><span class=o>.</span><span class=n>submodules</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;lay variables: </span><span class=si>{</span><span class=n>vs</span><span class=si>}</span><span class=s1>, trainables: </span><span class=si>{</span><span class=n>ts</span><span class=si>}</span><span class=s1>, submodules: </span><span class=si>{</span><span class=n>ms</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>constant</span><span class=p>([</span><span class=mi>100</span><span class=p>,</span> <span class=mi>100</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>mod</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>lay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>Checkpoint</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>mod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>CheckpointManager</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=s1>&#39;/tmp/q/trackable&#39;</span><span class=p>,</span> <span class=n>max_to_keep</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>mod</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>lay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=n>latest_checkpoint</span>
</span></span><span class=line><span class=cl>    <span class=n>vs</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>list_variables</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;containers: </span><span class=si>{</span><span class=n>vs</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=o>.</span><span class=n>restore</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;restored: </span><span class=si>{</span><span class=n>lay</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=a-most-simple-model>A most simple model</h2><p>We finally arrive at the most simple Keras model.</p><p>It uses just 3 scalar variables to showcase the underlying already tried and used persistence management:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>ins</span> <span class=o>=</span> <span class=p>[</span><span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Input</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>(),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>int32</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>lay</span> <span class=o>=</span> <span class=n>Layer</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;l1&#39;</span><span class=p>,</span> <span class=n>sub</span><span class=o>=</span><span class=n>Layer</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;l2&#39;</span><span class=p>,</span> <span class=n>sub</span><span class=o>=</span><span class=n>Layer</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;l3&#39;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>outs</span> <span class=o>=</span> <span class=p>[</span><span class=n>lay</span><span class=p>(</span><span class=n>ins</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>mod2</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Model</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;m2&#39;</span><span class=p>,</span> <span class=n>inputs</span><span class=o>=</span><span class=n>ins</span><span class=p>,</span> <span class=n>outputs</span><span class=o>=</span><span class=n>outs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>models</span><span class=p>(</span><span class=n>mod2</span><span class=p>,</span> <span class=n>lay</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  Model: <span class=s2>&#34;m2&#34;</span>
</span></span><span class=line><span class=cl>  _________________________________________________________________
</span></span><span class=line><span class=cl>  Layer <span class=o>(</span><span class=nb>type</span><span class=o>)</span>                 Output Shape              Param <span class=c1>#</span>
</span></span><span class=line><span class=cl>  <span class=o>=================================================================</span>
</span></span><span class=line><span class=cl>  input_1 <span class=o>(</span>InputLayer<span class=o>)</span>         <span class=o>[(</span>None,<span class=o>)]</span>                 <span class=m>0</span>
</span></span><span class=line><span class=cl>  _________________________________________________________________
</span></span><span class=line><span class=cl>  l1 <span class=o>(</span>Layer<span class=o>)</span>                   <span class=o>(</span>1, None<span class=o>)</span>                 <span class=nv>3</span>
</span></span><span class=line><span class=cl>  <span class=o>=================================================================</span>
</span></span><span class=line><span class=cl>  Total params: <span class=m>3</span>
</span></span><span class=line><span class=cl>  Trainable params: <span class=m>3</span>
</span></span><span class=line><span class=cl>  Non-trainable params: <span class=m>0</span>
</span></span><span class=line><span class=cl>  _________________________________________________________________
</span></span><span class=line><span class=cl>  None
</span></span><span class=line><span class=cl>  lay variables: <span class=o>[</span><span class=s1>&#39;l1/l_v:0&#39;</span>, <span class=s1>&#39;l1/l2/l_v:0&#39;</span>, <span class=s1>&#39;l1/l2/l3/l_v:0&#39;</span><span class=o>]</span>, trainables: <span class=o>[</span><span class=s1>&#39;l1/l_v:0&#39;</span>, <span class=s1>&#39;l1/l2/l_v:0&#39;</span>, <span class=s1>&#39;l1/l2/l3/l_v:0&#39;</span><span class=o>]</span>, submodules: <span class=o>[</span><span class=s1>&#39;input_1&#39;</span>, <span class=s1>&#39;l1&#39;</span>, <span class=s1>&#39;l2&#39;</span>, <span class=s1>&#39;l3&#39;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>  n: l1, v: 206, s: <span class=o>(</span>n: l2, v: 204, s: <span class=o>(</span>n: l3, v: 202<span class=o>))</span>
</span></span><span class=line><span class=cl>  n: l1, v: 1424, s: <span class=o>(</span>n: l2, v: 1012, s: <span class=o>(</span>n: l3, v: 604<span class=o>))</span>
</span></span><span class=line><span class=cl>  containers: <span class=o>[(</span><span class=s1>&#39;_CHECKPOINTABLE_OBJECT_GRAPH&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;model/layer_with_weights-0/l_v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;model/layer_with_weights-0/sub/l_v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;model/layer_with_weights-0/sub/sub/l_v/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])</span>, <span class=o>(</span><span class=s1>&#39;save_counter/.ATTRIBUTES/VARIABLE_VALUE&#39;</span>, <span class=o>[])]</span>
</span></span><span class=line><span class=cl>  restored: n: l1, v: 206, s: <span class=o>(</span>n: l2, v: 204, s: <span class=o>(</span>n: l3, v: 202<span class=o>))</span>
</span></span></code></pre></div><p>Nevertheless, even the simplest model can be overwhelming when expressed only textually.</p><p>TensorBoard is an accompanying tool that can help us in &ldquo;picturing&rdquo; the nested component graphs.</p><p>As &ldquo;a picture is worth a thousand words&rdquo;, <code>summary</code> data for TB is generated as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>graph</span><span class=p>(</span><span class=n>tracer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y%m</span><span class=si>%d</span><span class=s1>-%H%M%S&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/tmp/q/logs/func/</span><span class=si>{</span><span class=n>s</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>w</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>summary</span><span class=o>.</span><span class=n>create_file_writer</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>tf</span><span class=o>.</span><span class=n>summary</span><span class=o>.</span><span class=n>trace_on</span><span class=p>(</span><span class=n>graph</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># , profiler=True)</span>
</span></span><span class=line><span class=cl>    <span class=n>tracer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>w</span><span class=o>.</span><span class=n>as_default</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>tf</span><span class=o>.</span><span class=n>summary</span><span class=o>.</span><span class=n>trace_export</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;trace&#34;</span><span class=p>,</span> <span class=n>step</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>profiler_outdir</span><span class=o>=</span><span class=n>d</span><span class=p>)</span>
</span></span></code></pre></div><p>Please note that our trivially simple Keras model still implements data-driven Python recursion.</p><h2 id=new-pythonic-autograph>New Pythonic &lsquo;autograph&rsquo;</h2><p>The new <code>autograph</code> functionality allows us to use such intuitive, native expressions instead of the usual, but more cumbersome, TF &ldquo;graph ops&rdquo;.</p><p>Autograph code generation is invoked with the <code>tf.function</code> Python decorator. A later blog will highlight the most impressive features of this new approach to defining ops.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@tf</span><span class=o>.</span><span class=n>function</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>tracer2</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mod2</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>constant</span><span class=p>([</span><span class=mi>100</span><span class=p>,</span> <span class=mi>100</span><span class=p>]))</span>
</span></span></code></pre></div><p>In order to see the TB generated summaries, including the picture of our graph, we need to load the extension:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>%</span><span class=n>load_ext</span> <span class=n>tensorboard</span>
</span></span></code></pre></div><p>Then we generate the TB summaries by calling our <code>tracer</code> function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>graph</span><span class=p>(</span><span class=n>tracer2</span><span class=p>)</span>
</span></span></code></pre></div><p>And now we can view the zoom-able and clickable TB graph. If you haven&rsquo;t run the code, an already generated graph is <a href=generated/images/tech/trackable.pdf>here</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>#%tensorboard --logdir /tmp/q/logs/func</span>
</span></span></code></pre></div><p>This concludes our blog. For using the new GPU-related functionality, please click on our next blog.</p></div></main></div><footer class="qal-footer py-5 bg-light"><div class=container><div class=row><div class=col-lg><a class=d-inline-flex href=../../><svg xmlns="http://www.w3.org/2000/svg" width="40" height="32" class="d-block me-2" viewBox="0 0 118 94" role="img"><title>Silcrow</title><path d="m67.476567 58.848956q2.916668 2.114585 4.375002 4.812503t1.458334 5.942711q0 5.250002-4.520836 8.421879-4.520835 3.208335-10.60938 3.208335-5.541669.0-9.406254-2.552085-3.864586-2.552084-3.864586-6.270836.0-2.151043 1.421876-3.500002 1.421876-1.3125 3.208335-1.3125 1.932293.0 3.026043 1.09375 1.093751 1.130209 1.786459 3.609377.911459 3.09896 2.296876 3.97396 1.385418.911459 3.208335.911459 2.187501.0 3.75521-1.239584t1.567709-3.026043q0-1.458334-1.020833-3.135418-1.057293-1.640626-6.708337-5.468753-6.526045-4.375002-9.369796-6.781253-2.843751-2.44271-4.375002-5.322919-1.531251-2.916669-1.531251-6.19792.0-3.09896 1.348959-5.432294 1.385417-2.333335 3.208335-3.427085 1.822918-1.130209 4.302085-1.713543-3.098959-2.260418-4.666668-4.921877-1.56771-2.66146-1.56771-5.76042.0-5.322919 4.484378-8.640629 4.484377-3.354168 10.901046-3.354168 5.395836.0 9.333338 2.515626t3.937502 6.088545q0 2.114584-1.494792 3.463543-1.494793 1.348959-3.427085 1.348959-1.895834.0-2.843752-.984375-.947917-1.020834-1.859376-3.718752-.838542-2.552085-2.078125-3.609377-1.239584-1.057292-3.463544-1.057292-2.296876.0-3.937502 1.276042-1.604167 1.276043-1.604167 3.062502.0 2.041667 1.567709 3.682293 1.531251 1.640626 7.473962 5.432294 5.578128 3.572919 8.239587 5.76042 2.697918 2.151043 4.229169 5.140627 1.567709 2.989585 1.567709 6.453128.0 4.411461-2.078126 7.218754-2.078126 2.807293-6.270836 4.010418zm1.166667-7.000003q0-3.682293-6.234378-8.531254-6.19792-4.885419-9.187505-4.885419-1.385417.0-2.661459 1.09375-1.239584 1.057293-1.239584 2.515627.0 3.463543 6.307295 8.421879 6.343753 4.958335 9.260421 4.958335 1.53125.0 2.625001-1.057292 1.130209-1.057292 1.130209-2.515626z" fill="#0"/></svg><span class=fs-5>&copy; 2022 Qnarre</span></a><ul class="list-unstyled small text-muted"><li class=mb-2>Software is our passion.</li></ul></div></div></div></footer><script src=../../js/bootstrap.bundle.min.js></script>
<script src=../../js/script.min.js></script></body></html>
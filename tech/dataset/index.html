<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A quick narrative analyzer for &lsquo;bipolar&rsquo; text"><meta name=author content="Qnarre - Software is our passion"><meta name=generator content="Hugo 0.101.0"><meta name=docsearch:language content="en"><meta name=docsearch:version content="0.1.0"><title>Dataset - The Tensor &ldquo;Highway&rdquo; On-Ramp Â· Qnarre</title><link rel=canonical href=https://quantapix.github.io/tech/dataset/><link href=../../css/bootstrap.min.css rel=stylesheet><link href=../../css/style.css rel=stylesheet><link rel=apple-touch-icon href=../../img/favs/apple-touch-icon.png sizes=180x180><link rel=icon href=../../img/favs/favicon-32x32.png sizes=32x32 type=image/png><link rel=icon href=../../img/favs/favicon-16x16.png sizes=16x16 type=image/png><link rel=manifest href=../../img/favs/manifest.json><link rel=mask-icon href=../../img/favs/safari-pinned-tab color=#7952b3><link rel=icon href=../../img/favs/favicon.ico><meta name=theme-color content="#7952b3"></head><body><div class="skippy visually-hidden-focusable overflow-hidden"><div class=container-xl><a class="d-inline-flex p-2 m-1" href=#content>Skip to content</a></div></div><header class="navbar navbar-expand-md navbar-dark qal-navbar"><nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-2" href=../../><svg xmlns="http://www.w3.org/2000/svg" width="40" height="32" class="d-block my-1" viewBox="0 0 118 94" role="img"><title>Silcrow</title><path d="m67.476567 58.848956q2.916668 2.114585 4.375002 4.812503t1.458334 5.942711q0 5.250002-4.520836 8.421879-4.520835 3.208335-10.60938 3.208335-5.541669.0-9.406254-2.552085-3.864586-2.552084-3.864586-6.270836.0-2.151043 1.421876-3.500002 1.421876-1.3125 3.208335-1.3125 1.932293.0 3.026043 1.09375 1.093751 1.130209 1.786459 3.609377.911459 3.09896 2.296876 3.97396 1.385418.911459 3.208335.911459 2.187501.0 3.75521-1.239584t1.567709-3.026043q0-1.458334-1.020833-3.135418-1.057293-1.640626-6.708337-5.468753-6.526045-4.375002-9.369796-6.781253-2.843751-2.44271-4.375002-5.322919-1.531251-2.916669-1.531251-6.19792.0-3.09896 1.348959-5.432294 1.385417-2.333335 3.208335-3.427085 1.822918-1.130209 4.302085-1.713543-3.098959-2.260418-4.666668-4.921877-1.56771-2.66146-1.56771-5.76042.0-5.322919 4.484378-8.640629 4.484377-3.354168 10.901046-3.354168 5.395836.0 9.333338 2.515626t3.937502 6.088545q0 2.114584-1.494792 3.463543-1.494793 1.348959-3.427085 1.348959-1.895834.0-2.843752-.984375-.947917-1.020834-1.859376-3.718752-.838542-2.552085-2.078125-3.609377-1.239584-1.057292-3.463544-1.057292-2.296876.0-3.937502 1.276042-1.604167 1.276043-1.604167 3.062502.0 2.041667 1.567709 3.682293 1.531251 1.640626 7.473962 5.432294 5.578128 3.572919 8.239587 5.76042 2.697918 2.151043 4.229169 5.140627 1.567709 2.989585 1.567709 6.453128.0 4.411461-2.078126 7.218754-2.078126 2.807293-6.270836 4.010418zm1.166667-7.000003q0-3.682293-6.234378-8.531254-6.19792-4.885419-9.187505-4.885419-1.385417.0-2.661459 1.09375-1.239584 1.057293-1.239584 2.515627.0 3.463543 6.307295 8.421879 6.343753 4.958335 9.260421 4.958335 1.53125.0 2.625001-1.057292 1.130209-1.057292 1.130209-2.515626z" fill="#fff"/></svg></a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#qalNavbar aria-controls=qalNavbar aria-expanded=false aria-label="Toggle navigation"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" class="bi" fill="currentcolor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 11.5A.5.5.0 013 11h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5zm0-4A.5.5.0 013 7h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5zm0-4A.5.5.0 013 3h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5z"/></svg></button><div class="collapse navbar-collapse" id=qalNavbar><hr class="d-md-none text-white-50"><ul class="navbar-nav flex-row flex-wrap qal-navbar-nav"><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../>Qnarre</a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../modeling/>Modeling</a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../semantics/>Semantics</a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../analytics/>Analytics</a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../reports/>Reports</a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../story/>The Story</a></li></ul><hr class="d-md-none text-white-50"><ul class="navbar-nav flex-row flex-wrap ms-md-auto"><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=https://twitter.com/ikifor target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" class="navbar-nav-svg d-inline-block align-text-top" viewBox="0 0 512 416.32" role="img"><title>Twitter</title><path fill="currentcolor" d="M160.83 416.32c193.2.0 298.92-160.22 298.92-298.92.0-4.51.0-9-.2-13.52A214 214 0 00512 49.38a212.93 212.93.0 01-60.44 16.6 105.7 105.7.0 0046.3-58.19 209 209 0 01-66.79 25.37 105.09 105.09.0 00-181.73 71.91 116.12 116.12.0 002.66 24c-87.28-4.3-164.73-46.3-216.56-109.82A105.48 105.48.0 0068 159.6a106.27 106.27.0 01-47.53-13.11v1.43a105.28 105.28.0 0084.21 103.06 105.67 105.67.0 01-47.33 1.84 105.06 105.06.0 0098.14 72.94A210.72 210.72.0 0125 370.84a202.17 202.17.0 01-25-1.43 298.85 298.85.0 00160.83 46.92"/></svg><small class="d-md-none ms-2">Twitter</small></a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=https://github.com/quantapix target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" class="navbar-nav-svg d-inline-block align-text-top" viewBox="0 0 512 499.36" role="img"><title>GitHub</title><path fill="currentcolor" fill-rule="evenodd" d="M256 0C114.64.0.0 114.61.0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34.0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49.0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75.0.0 21.49-6.88 70.4 26.24a242.65 242.65.0 01128.18.0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69.0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41.0 34.22-.31 61.83-.31 70.23.0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37.0 256 0z"/></svg><small class="d-md-none ms-2">GitHub</small></a></li></ul><a class="btn btn-qal-download d-lg-inline-block my-2 my-md-0 ms-md-3" href=../../simlaw/>SimLaw.app</a></div></nav></header><div class="container-xxl my-md-4 qal-layout"><aside class=qal-sidebar><nav class="collapse qal-links" id=qal-docs-nav aria-label="Nav links"><ul class="list-unstyled mb-0 py-3 pt-md-1"><li class=mb-1><button class="btn d-inline-flex align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#modeling-collapse aria-expanded=false>
Modeling</button><div class=collapse id=modeling-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../modeling/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../modeling/simulation class="d-inline-flex align-items-center rounded">Judicial Simulation</a></li><li><a href=../../modeling/concepts class="d-inline-flex align-items-center rounded">Conceptual Model</a></li><li><a href=../../modeling/report class="d-inline-flex align-items-center rounded">Sample Report</a></li></ul></div></li><li class=mb-1><button class="btn d-inline-flex align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#semantics-collapse aria-expanded=false>
Semantics</button><div class=collapse id=semantics-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../semantics/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../semantics/simulation class="d-inline-flex align-items-center rounded">Judicial Simulation</a></li><li><a href=../../semantics/concepts class="d-inline-flex align-items-center rounded">Conceptual Model</a></li></ul></div></li><li class=mb-1><button class="btn d-inline-flex align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#analytics-collapse aria-expanded=false>
Analytics</button><div class=collapse id=analytics-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../analytics/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../analytics/prepare class="d-inline-flex align-items-center rounded">Preparing Documents</a></li><li><a href=../../analytics/extract class="d-inline-flex align-items-center rounded">Extracting Narratives</a></li><li><a href=../../analytics/output class="d-inline-flex align-items-center rounded">Standardized Output</a></li><li><a href=../../analytics/graph class="d-inline-flex align-items-center rounded">Conflict Graph</a></li><li><a href=../../analytics/analyze class="d-inline-flex align-items-center rounded">Irrefutable Analytics</a></li></ul></div></li><li class=mb-1><button class="btn d-inline-flex align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#reports-collapse aria-expanded=false>
Reports</button><div class=collapse id=reports-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../reports/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../reports/prepare class="d-inline-flex align-items-center rounded">Generating Reports</a></li></ul></div></li><li class=mb-1><button class="btn d-inline-flex align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#story-collapse aria-expanded=false>
The Story</button><div class=collapse id=story-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../story/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../story/about class="d-inline-flex align-items-center rounded">About</a></li><li><a href=../../story/blog class="d-inline-flex align-items-center rounded">Blog</a></li></ul></div></li><li class=mb-1><button class="btn d-inline-flex align-items-center rounded" data-bs-toggle=collapse data-bs-target=#tech-collapse aria-expanded=true aria-current=true>
Available Tech</button><div class="collapse show" id=tech-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../tech/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../tech/trackable class="d-inline-flex align-items-center rounded">Trackable Persistence</a></li><li><a href=../../tech/gpus class="d-inline-flex align-items-center rounded">Many Smaller GPUs</a></li><li><a href=../../tech/dataset class="d-inline-flex align-items-center rounded active" aria-current=page>Datasets</a></li><li><a href=../../tech/masking class="d-inline-flex align-items-center rounded">Unified Masking</a></li><li><a href=../../tech/ragged class="d-inline-flex align-items-center rounded">Ragged Tensors</a></li><li><a href=../../tech/layers class="d-inline-flex align-items-center rounded">Layers Simplified</a></li><li><a href=../../tech/custom class="d-inline-flex align-items-center rounded">Custom Layers</a></li><li><a href=../../tech/autograph class="d-inline-flex align-items-center rounded">Autograph</a></li><li><a href=../../tech/metrics class="d-inline-flex align-items-center rounded">Modular Metrics</a></li><li><a href=../../tech/callbacks class="d-inline-flex align-items-center rounded">Extended Callbacks</a></li></ul></div></li></ul></nav></aside><main class="qal-main order-1"><div class="qal-intro ps-lg-4"><div class="d-md-flex flex-md-row align-items-center justify-content-between"><h1 class=qal-title id=content>Dataset - The Tensor &ldquo;Highway&rdquo; On-Ramp</h1></div><p class=qal-lead></p></div><div class="qal-toc mt-4 mb-5 my-md-0 ps-xl-3 mb-lg-5 text-muted"><strong class="d-block h6 my-2 pb-2 border-bottom">On this page</strong><nav id=TableOfContents><ul><li><a href=#elementary-arithmetic>Elementary arithmetic</a></li><li><a href=#our-params-class-again>Our Params class again</a></li><li><a href=#synthesize-lots-of-clean-data>Synthesize lots of &ldquo;clean&rdquo; data</a></li><li><a href=#dataset-class>Dataset class</a></li><li><a href=#data-pipelines-and-ops>Data pipelines and ops</a></li><li><a href=#filaments-of-data>&ldquo;Filaments&rdquo; of data</a></li><li><a href=#sharded-binary-storage>Sharded binary storage</a></li><li><a href=#loading-data>Loading data</a></li><li><a href=#batching-data>Batching data</a></li></ul></nav></div><div class="qal-content ps-lg-4"><p>Machine learning is about lots and lots of data. Organizing the input data is an error-prone, arduous task.</p><p>TensorFlow <code>datasets</code> were designed to build complex input data pipelines from simple, reusable pieces with the clear objective of normalizing that process.</p><p>This blog shows off some of the useful features of this new approach to &ldquo;feed the beast&rdquo;.</p><p>Before we can run any meaningful code, we first need to prep our environment:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pathlib</span> <span class=k>as</span> <span class=nn>pth</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tensorflow</span> <span class=k>as</span> <span class=nn>tf</span>
</span></span></code></pre></div><p>For convenience, and brevity, let&rsquo;s create some aliases as well:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>td</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>data</span>
</span></span><span class=line><span class=cl><span class=n>tt</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span>
</span></span></code></pre></div><h2 id=elementary-arithmetic>Elementary arithmetic</h2><p>While computers were made to add numbers together, they quickly run into insurmountable obstacles if these numbers are presented as simple textual sequences of digits.</p><p>We aim to finally &ldquo;teach&rdquo; our computer to correctly add and multiply, just as we learned in elementary school. And we start with a simple yet fascinating example, inspired by <a href=https://arxiv.org/pdf/1812.02825.pdf>here</a>.</p><p>Our input data consists of <code>num_samples</code> (perhaps easily millions) of <code>"x=-12,y=24:y+x:12"</code>-like strings, or lines, of texts. These visibly consist of <code>defs</code>, <code>op</code> and <code>res</code> fields (separated by <code>:</code>).</p><p>Our variables are: <code>x</code> and <code>y</code>, our &ldquo;operations&rdquo; are: <code>=</code>, <code>+</code>, <code>-</code> and <code>*</code>, and our variables can be assigned values from: <code>[-max_val, max_val]</code>.</p><p>The rest of the blogs in this group will continue to build on the below presented results:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>vocab</span> <span class=o>=</span> <span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>,</span> <span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=s1>&#39;|&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>vocab</span> <span class=o>+=</span> <span class=p>(</span><span class=s1>&#39;x&#39;</span><span class=p>,</span> <span class=s1>&#39;y&#39;</span><span class=p>,</span> <span class=s1>&#39;=&#39;</span><span class=p>,</span> <span class=s1>&#39;,&#39;</span><span class=p>,</span> <span class=s1>&#39;+&#39;</span><span class=p>,</span> <span class=s1>&#39;-&#39;</span><span class=p>,</span> <span class=s1>&#39;*&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>vocab</span> <span class=o>+=</span> <span class=p>(</span><span class=s1>&#39;0&#39;</span><span class=p>,</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;2&#39;</span><span class=p>,</span> <span class=s1>&#39;3&#39;</span><span class=p>,</span> <span class=s1>&#39;4&#39;</span><span class=p>,</span> <span class=s1>&#39;5&#39;</span><span class=p>,</span> <span class=s1>&#39;6&#39;</span><span class=p>,</span> <span class=s1>&#39;7&#39;</span><span class=p>,</span> <span class=s1>&#39;8&#39;</span><span class=p>,</span> <span class=s1>&#39;9&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>We also intend to make our input data pipeline parametric.</p><p>However, the obvious simple and intuitive Python <code>dict</code> structures, with literal string keys, are error-prone exactly because of unchecked literals.</p><h2 id=our-params-class-again>Our Params class again</h2><p>A few lines of code gives as the <code>Params</code> class that leverages the native Python attribute mechanism to validate the names of all our params:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>params</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>max_val</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>num_samples</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>num_shards</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Params</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>**</span><span class=n>kw</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>kw</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=nb>setattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=synthesize-lots-of-clean-data>Synthesize lots of &ldquo;clean&rdquo; data</h2><p>Let&rsquo;s now randomly generate our data, fittingly as a Python generator, and based on a given <code>Params</code> instance. For this we define:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>py_gen</span><span class=p>(</span><span class=n>ps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span><span class=p>,</span> <span class=n>n</span> <span class=o>=</span> <span class=n>ps</span><span class=o>.</span><span class=n>max_val</span><span class=p>,</span> <span class=n>ps</span><span class=o>.</span><span class=n>num_samples</span>
</span></span><span class=line><span class=cl>    <span class=c1># x, y vals in defs</span>
</span></span><span class=line><span class=cl>    <span class=n>vals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=n>low</span><span class=o>=</span><span class=mi>1</span> <span class=o>-</span> <span class=n>m</span><span class=p>,</span> <span class=n>high</span><span class=o>=</span><span class=n>m</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1># (x, y) order if 1 in defs [0] and op [1], respectively</span>
</span></span><span class=line><span class=cl>    <span class=n>ords</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1># index of [&#39;+&#39;, &#39;-&#39;, &#39;*&#39;]</span>
</span></span><span class=line><span class=cl>    <span class=n>ops</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=s1>&#39;+&#39;</span><span class=p>,</span> <span class=s1>&#39;-&#39;</span><span class=p>,</span> <span class=s1>&#39;*&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>ops</span><span class=o>.</span><span class=n>reshape</span><span class=p>((</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>ops</span> <span class=o>=</span> <span class=n>ops</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=n>vals</span><span class=p>[:,</span> <span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;x=</span><span class=si>{</span><span class=n>x</span><span class=si>}</span><span class=s1>,y=</span><span class=si>{</span><span class=n>y</span><span class=si>}</span><span class=s1>:&#39;</span> <span class=k>if</span> <span class=n>ords</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span> <span class=k>else</span> <span class=sa>f</span><span class=s1>&#39;y=</span><span class=si>{</span><span class=n>y</span><span class=si>}</span><span class=s1>,x=</span><span class=si>{</span><span class=n>x</span><span class=si>}</span><span class=s1>:&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>o</span> <span class=o>=</span> <span class=n>ops</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>+=</span> <span class=p>(</span><span class=sa>f</span><span class=s1>&#39;x</span><span class=si>{</span><span class=n>o</span><span class=si>}</span><span class=s1>y:&#39;</span> <span class=k>if</span> <span class=n>ords</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span> <span class=k>else</span> <span class=sa>f</span><span class=s1>&#39;y</span><span class=si>{</span><span class=n>o</span><span class=si>}</span><span class=s1>x:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>o</span> <span class=o>==</span> <span class=s1>&#39;+&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>x</span> <span class=o>+</span> <span class=n>y</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>o</span> <span class=o>==</span> <span class=s1>&#39;*&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>x</span> <span class=o>*</span> <span class=n>y</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>assert</span> <span class=n>o</span> <span class=o>==</span> <span class=s1>&#39;-&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=o>+=</span> <span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>x</span> <span class=o>-</span> <span class=n>y</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>if</span> <span class=n>ords</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span> <span class=k>else</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>y</span> <span class=o>-</span> <span class=n>x</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>res</span>
</span></span></code></pre></div><p>With our generator defined, it takes just a line of code to create millions of correct &ldquo;exercises&rdquo; or samples for our training sessions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>ps</span> <span class=o>=</span> <span class=n>Params</span><span class=p>(</span><span class=o>**</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>py_gen</span><span class=p>(</span><span class=n>ps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  <span class=nv>y</span><span class=o>=</span>-4,x<span class=o>=</span>4:y-x:-8
</span></span><span class=line><span class=cl>  <span class=nv>y</span><span class=o>=</span>4,x<span class=o>=</span>-8:y*x:-32
</span></span><span class=line><span class=cl>  <span class=nv>y</span><span class=o>=</span>-8,x<span class=o>=</span>7:y-x:-15
</span></span><span class=line><span class=cl>  <span class=nv>y</span><span class=o>=</span>-4,x<span class=o>=</span>9:y+x:5
</span></span></code></pre></div><h2 id=dataset-class>Dataset class</h2><p>The <code>tf.data.Dataset</code> class is the main abstraction for our sequence of elements.</p><p>Each element of a dataset is one or more Tensors containing the fields, or <code>features</code>, of our <code>sample</code> &ldquo;lines&rdquo; of elementary math exercises.</p><p>Using our &ldquo;in-memory&rdquo; generator, we can directly create a TF dataset as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>gen_src</span><span class=p>(</span><span class=n>ps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ds</span> <span class=o>=</span> <span class=n>td</span><span class=o>.</span><span class=n>Dataset</span><span class=o>.</span><span class=n>from_generator</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>lambda</span><span class=p>:</span> <span class=n>py_gen</span><span class=p>(</span><span class=n>ps</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>tf</span><span class=o>.</span><span class=n>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>tf</span><span class=o>.</span><span class=n>TensorShape</span><span class=p>([]),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ds</span>
</span></span></code></pre></div><p>And here are the first 2 samples of the now tensor-based sequence:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>dg</span> <span class=o>=</span> <span class=n>gen_src</span><span class=p>(</span><span class=n>ps</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>dg</span><span class=o>.</span><span class=n>take</span><span class=p>(</span><span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  tf.Tensor<span class=o>(</span>b<span class=s1>&#39;x=-6,y=0:x+y:-6&#39;</span>, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>string<span class=o>)</span>
</span></span><span class=line><span class=cl>  tf.Tensor<span class=o>(</span>b<span class=s1>&#39;y=1,x=7:y+x:8&#39;</span>, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>string<span class=o>)</span>
</span></span></code></pre></div><h2 id=data-pipelines-and-ops>Data pipelines and ops</h2><p>An input data pipeline starts with a &ldquo;source&rdquo; dataset, perhaps just as simple as the above.</p><p>This &ldquo;source&rdquo; can also be a <code>range</code>, <code>from_tensor_slices</code>, <code>from_tensors</code> and even a <code>TextLineDataset</code> (see the TF docs).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>src_dset</span><span class=p>(</span><span class=n>ps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ds</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>py_gen</span><span class=p>(</span><span class=n>ps</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>ds</span> <span class=o>=</span> <span class=n>td</span><span class=o>.</span><span class=n>Dataset</span><span class=o>.</span><span class=n>from_tensor_slices</span><span class=p>(</span><span class=n>ds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ds</span>
</span></span></code></pre></div><p>All datasets can then be consumed one-by-one as iterables or as aggregatables (e.g. using reduce ops) collections.</p><p>Datasets also allow chaining of handy &ldquo;transformations&rdquo; to themselves. Some of the canned operations are the intuitive: <em>cache, concatenate, enumerate, reduce, repeat, shuffle, skip, take, zip</em>.</p><p>An example of 2 samples of a new dataset, concatenated with all 4 samples of the previous, gen-based, dataset and also &ldquo;enumerated&rdquo; on-the-fly is as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>ds</span> <span class=o>=</span> <span class=n>src_dset</span><span class=p>(</span><span class=n>ps</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>ds</span><span class=o>.</span><span class=n>take</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>dg</span><span class=p>)</span><span class=o>.</span><span class=n>enumerate</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  tf.Tensor<span class=o>(</span>0, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>int64<span class=o>)</span> tf.Tensor<span class=o>(</span>b<span class=s1>&#39;x=9,y=-9:y+x:0&#39;</span>, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>string<span class=o>)</span>
</span></span><span class=line><span class=cl>  tf.Tensor<span class=o>(</span>1, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>int64<span class=o>)</span> tf.Tensor<span class=o>(</span>b<span class=s1>&#39;x=-4,y=2:y+x:-2&#39;</span>, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>string<span class=o>)</span>
</span></span><span class=line><span class=cl>  tf.Tensor<span class=o>(</span>2, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>int64<span class=o>)</span> tf.Tensor<span class=o>(</span>b<span class=s1>&#39;x=5,y=-7:y-x:-12&#39;</span>, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>string<span class=o>)</span>
</span></span><span class=line><span class=cl>  tf.Tensor<span class=o>(</span>3, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>int64<span class=o>)</span> tf.Tensor<span class=o>(</span>b<span class=s1>&#39;y=-4,x=1:x+y:-3&#39;</span>, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>string<span class=o>)</span>
</span></span><span class=line><span class=cl>  tf.Tensor<span class=o>(</span>4, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>int64<span class=o>)</span> tf.Tensor<span class=o>(</span>b<span class=s1>&#39;y=2,x=4:x-y:2&#39;</span>, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>string<span class=o>)</span>
</span></span><span class=line><span class=cl>  tf.Tensor<span class=o>(</span>5, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>int64<span class=o>)</span> tf.Tensor<span class=o>(</span>b<span class=s1>&#39;y=-6,x=-5:y-x:-1&#39;</span>, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>string<span class=o>)</span>
</span></span></code></pre></div><p>We can also filter our to be &ldquo;pipeline&rdquo; at any stage, with the objective of perhaps dropping unfit samples:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@tf</span><span class=o>.</span><span class=n>function</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>filterer</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>strings</span><span class=o>.</span><span class=n>length</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>15</span>
</span></span><span class=line><span class=cl>    <span class=n>tf</span><span class=o>.</span><span class=n>print</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>strings</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s1>&#39;filtering </span><span class=si>{}</span><span class=s1>... &#39;</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=s1>&#39;in&#39;</span> <span class=k>if</span> <span class=n>r</span> <span class=k>else</span> <span class=s1>&#39;out&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>s</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>ds</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>filterer</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  filtering <span class=s2>&#34;x=9,y=-9:y+x:0&#34;</span>... in
</span></span><span class=line><span class=cl>  <span class=m>0</span> tf.Tensor<span class=o>(</span>b<span class=s1>&#39;x=9,y=-9:y+x:0&#39;</span>, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>string<span class=o>)</span>
</span></span><span class=line><span class=cl>  filtering <span class=s2>&#34;x=-4,y=2:y+x:-2&#34;</span>... out
</span></span><span class=line><span class=cl>  filtering <span class=s2>&#34;x=-2,y=3:x*y:-6&#34;</span>... out
</span></span><span class=line><span class=cl>  filtering <span class=s2>&#34;x=-3,y=5:y-x:8&#34;</span>... in
</span></span><span class=line><span class=cl>  <span class=m>1</span> tf.Tensor<span class=o>(</span>b<span class=s1>&#39;x=-3,y=5:y-x:8&#39;</span>, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>string<span class=o>)</span>
</span></span></code></pre></div><h2 id=filaments-of-data>&ldquo;Filaments&rdquo; of data</h2><p>More importantly, we can split the pipeline into named &ldquo;filaments&rdquo; of data.</p><p>This new feature proves to be extremely useful, allowing us to standardize and unify all our data sources with configurable, on-the-fly channeling of features aggregated therein:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@tf</span><span class=o>.</span><span class=n>function</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>splitter</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>fs</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>strings</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;defs&#39;</span><span class=p>:</span> <span class=n>fs</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=s1>&#39;op&#39;</span><span class=p>:</span> <span class=n>fs</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=s1>&#39;res&#39;</span><span class=p>:</span> <span class=n>fs</span><span class=p>[</span><span class=mi>2</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>ds</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>splitter</span><span class=p>)</span><span class=o>.</span><span class=n>take</span><span class=p>(</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  <span class=o>{</span><span class=s1>&#39;defs&#39;</span>: &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>207, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>string, <span class=nv>numpy</span><span class=o>=</span>b<span class=s1>&#39;x=9,y=-9&#39;</span>&gt;, <span class=s1>&#39;op&#39;</span>: &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>208, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>string, <span class=nv>numpy</span><span class=o>=</span>b<span class=s1>&#39;y+x&#39;</span>&gt;, <span class=s1>&#39;res&#39;</span>: &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>209, <span class=nv>shape</span><span class=o>=()</span>, <span class=nv>dtype</span><span class=o>=</span>string, <span class=nv>numpy</span><span class=o>=</span>b<span class=s1>&#39;0&#39;</span>&gt;<span class=o>}</span>
</span></span></code></pre></div><p>Another example of a &ldquo;pipeline component&rdquo; is an in-line Python <code>dict</code>-based tokenizer:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>tokens</span> <span class=o>=</span> <span class=p>{</span><span class=n>c</span><span class=p>:</span> <span class=n>i</span> <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>vocab</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tf</span><span class=o>.</span><span class=n>function</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>tokenizer</span><span class=p>(</span><span class=n>d</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>k</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>numpy_function</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>constant</span><span class=p>([</span><span class=n>tokens</span><span class=p>[</span><span class=nb>chr</span><span class=p>(</span><span class=n>c</span><span class=p>)]</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>x</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=n>v</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>Tout</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>int32</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>d</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>ds</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>splitter</span><span class=p>)</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>tokenizer</span><span class=p>)</span><span class=o>.</span><span class=n>take</span><span class=p>(</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  <span class=o>{</span><span class=s1>&#39;defs&#39;</span>: &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>258, <span class=nv>shape</span><span class=o>=(</span>8,<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int32, <span class=nv>numpy</span><span class=o>=</span>array<span class=o>([</span> 3,  5, 19,  6,  4,  5,  8, 19<span class=o>]</span>, <span class=nv>dtype</span><span class=o>=</span>int32<span class=o>)</span>&gt;, <span class=s1>&#39;op&#39;</span>: &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>259, <span class=nv>shape</span><span class=o>=(</span>3,<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int32, <span class=nv>numpy</span><span class=o>=</span>array<span class=o>([</span>4, 7, 3<span class=o>]</span>, <span class=nv>dtype</span><span class=o>=</span>int32<span class=o>)</span>&gt;, <span class=s1>&#39;res&#39;</span>: &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>260, <span class=nv>shape</span><span class=o>=(</span>1,<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int32, <span class=nv>numpy</span><span class=o>=</span>array<span class=o>([</span>10<span class=o>]</span>, <span class=nv>dtype</span><span class=o>=</span>int32<span class=o>)</span>&gt;<span class=o>}</span>
</span></span></code></pre></div><h2 id=sharded-binary-storage>Sharded binary storage</h2><p>Datasets can be potentially very large, fitting only on disk and in many files.</p><p>As transparent data-pipeline performance is key for training throughput, datasets can also be efficiently encoded into binary sequences stored in <code>sharded</code> files.</p><p>The following will convert our samples into such binary &ldquo;records&rdquo;:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>records</span><span class=p>(</span><span class=n>dset</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>dset</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>fs</span> <span class=o>=</span> <span class=n>tt</span><span class=o>.</span><span class=n>Features</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>feature</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;defs&#39;</span><span class=p>:</span> <span class=n>tt</span><span class=o>.</span><span class=n>Feature</span><span class=p>(</span><span class=n>int64_list</span><span class=o>=</span><span class=n>tt</span><span class=o>.</span><span class=n>Int64List</span><span class=p>(</span><span class=n>value</span><span class=o>=</span><span class=n>s</span><span class=p>[</span><span class=s1>&#39;defs&#39;</span><span class=p>])),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;op&#39;</span><span class=p>:</span> <span class=n>tt</span><span class=o>.</span><span class=n>Feature</span><span class=p>(</span><span class=n>int64_list</span><span class=o>=</span><span class=n>tt</span><span class=o>.</span><span class=n>Int64List</span><span class=p>(</span><span class=n>value</span><span class=o>=</span><span class=n>s</span><span class=p>[</span><span class=s1>&#39;op&#39;</span><span class=p>])),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;res&#39;</span><span class=p>:</span> <span class=n>tt</span><span class=o>.</span><span class=n>Feature</span><span class=p>(</span><span class=n>int64_list</span><span class=o>=</span><span class=n>tt</span><span class=o>.</span><span class=n>Int64List</span><span class=p>(</span><span class=n>value</span><span class=o>=</span><span class=n>s</span><span class=p>[</span><span class=s1>&#39;res&#39;</span><span class=p>])),</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>tt</span><span class=o>.</span><span class=n>Example</span><span class=p>(</span><span class=n>features</span><span class=o>=</span><span class=n>fs</span><span class=p>)</span><span class=o>.</span><span class=n>SerializeToString</span><span class=p>()</span>
</span></span></code></pre></div><p>And we can &ldquo;dump&rdquo; our tokenized, ready-to-consume samples into shards of files stored in a directory.</p><p>Once these prepared samples are stored, we can &ldquo;stream&rdquo; them straight into our models without any more prep (see subsequent blogs):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>shards</span><span class=p>(</span><span class=n>ps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>ps</span><span class=o>.</span><span class=n>num_shards</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>src_dset</span><span class=p>(</span><span class=n>ps</span><span class=p>)</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>splitter</span><span class=p>)</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>tokenizer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dump</span><span class=p>(</span><span class=n>ps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>pth</span><span class=o>.</span><span class=n>Path</span><span class=p>(</span><span class=s1>&#39;/tmp/q/dataset&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>parents</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>ds</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>shards</span><span class=p>(</span><span class=n>ps</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=si>{:0&gt;4d}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>d</span> <span class=o>/</span> <span class=sa>f</span><span class=s1>&#39;shard_</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>.tfrecords&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;dumping </span><span class=si>{</span><span class=n>p</span><span class=si>}</span><span class=s1>...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>tf</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>TFRecordWriter</span><span class=p>(</span><span class=n>p</span><span class=p>)</span> <span class=k>as</span> <span class=n>w</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>records</span><span class=p>(</span><span class=n>ds</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>w</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fs</span> <span class=o>=</span> <span class=p>[</span><span class=n>f</span> <span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>dump</span><span class=p>(</span><span class=n>ps</span><span class=p>)]</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  dumping /tmp/q/dataset/shard_0000.tfrecords...
</span></span><span class=line><span class=cl>  dumping /tmp/q/dataset/shard_0001.tfrecords...
</span></span><span class=line><span class=cl>  dumping /tmp/q/dataset/shard_0002.tfrecords...
</span></span></code></pre></div><h2 id=loading-data>Loading data</h2><p>For streaming, or loading the &ldquo;records&rdquo; back, we need to create templates used in interpreting the stored binary data.</p><p>With the templates defined, loading them back in, straight into our datasets, can be just as follows.</p><p>Note that the names of the shard files are conveniently returned by our &ldquo;dump&rdquo; function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>features</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;defs&#39;</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>VarLenFeature</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>int64</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;op&#39;</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>VarLenFeature</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>int64</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;res&#39;</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>VarLenFeature</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>int64</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>load</span><span class=p>(</span><span class=n>ps</span><span class=p>,</span> <span class=n>files</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ds</span> <span class=o>=</span> <span class=n>td</span><span class=o>.</span><span class=n>TFRecordDataset</span><span class=p>(</span><span class=n>files</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>ps</span><span class=o>.</span><span class=n>dim_batch</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ds</span> <span class=o>=</span> <span class=n>ds</span><span class=o>.</span><span class=n>batch</span><span class=p>(</span><span class=n>ps</span><span class=o>.</span><span class=n>dim_batch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ds</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>parse_example</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>features</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ds</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>parse_single_example</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>features</span><span class=p>))</span>
</span></span></code></pre></div><p>Before we actually start using the loaded data in our models, let&rsquo;s &ldquo;adapt&rdquo; the pipeline to supply dense tensors instead of the originally configured sparse ones.</p><p>Also, since we haven&rsquo;t batched anything yet, we set <code>dim_batch</code> to <code>None</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@tf</span><span class=o>.</span><span class=n>function</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>adapter</span><span class=p>(</span><span class=n>d</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>tf</span><span class=o>.</span><span class=n>sparse</span><span class=o>.</span><span class=n>to_dense</span><span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=s1>&#39;defs&#39;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>        <span class=n>tf</span><span class=o>.</span><span class=n>sparse</span><span class=o>.</span><span class=n>to_dense</span><span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=s1>&#39;op&#39;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>        <span class=n>tf</span><span class=o>.</span><span class=n>sparse</span><span class=o>.</span><span class=n>to_dense</span><span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=s1>&#39;res&#39;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ps</span><span class=o>.</span><span class=n>dim_batch</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>s</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>load</span><span class=p>(</span><span class=n>ps</span><span class=p>,</span> <span class=n>fs</span><span class=p>)</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>adapter</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>s</span><span class=p>))</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  <span class=m>0</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>  <span class=m>1</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>  <span class=m>2</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>  <span class=m>3</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>  <span class=m>4</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>  <span class=m>5</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>  <span class=m>6</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>  <span class=m>7</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>  <span class=m>8</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>  <span class=m>9</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>  <span class=m>10</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>  <span class=m>11</span> <span class=m>3</span>
</span></span></code></pre></div><p>The listing above reveals that we merged 3 sharded files, worth 4 samples each, into the 12 printed samples. We only printed the number of features for each sample, for brevity.</p><p><strong>Please also note</strong> how the above in-line adapter converted our named features into unnamed, positional, i.e. in-a-list features. This was necessary as the Keras <code>Input</code> doesn&rsquo;t recognize named input tensors yet.</p><h2 id=batching-data>Batching data</h2><p>If we turn on batching in our dataset, the same code will now return the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>ps</span><span class=o>.</span><span class=n>dim_batch</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>s</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>load</span><span class=p>(</span><span class=n>ps</span><span class=p>,</span> <span class=n>fs</span><span class=p>)</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>adapter</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  <span class=m>0</span> <span class=o>(</span>&lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1362, <span class=nv>shape</span><span class=o>=(</span>2, 8<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span> 4,  5, 14,  6,  3,  5,  8, 11<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span> 3,  5, 11,  6,  4,  5,  8, 12<span class=o>]])</span>&gt;, &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1363, <span class=nv>shape</span><span class=o>=(</span>2, 3<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span>4, 7, 3<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span>4, 8, 3<span class=o>]])</span>&gt;, &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1364, <span class=nv>shape</span><span class=o>=(</span>2, 2<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span>13,  0<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span> 8, 13<span class=o>]])</span>&gt;<span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=m>1</span> <span class=o>(</span>&lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1368, <span class=nv>shape</span><span class=o>=(</span>2, 9<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span> 4,  5,  8, 16,  6,  3,  5,  8, 16<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span> 4,  5,  8, 12,  6,  3,  5,  8, 14<span class=o>]])</span>&gt;, &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1369, <span class=nv>shape</span><span class=o>=(</span>2, 3<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span>3, 8, 4<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span>3, 9, 4<span class=o>]])</span>&gt;, &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1370, <span class=nv>shape</span><span class=o>=(</span>2, 1<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span>10<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span>18<span class=o>]])</span>&gt;<span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=m>2</span> <span class=o>(</span>&lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1374, <span class=nv>shape</span><span class=o>=(</span>2, 8<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span> 3,  5,  8, 11,  6,  4,  5, 10<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span> 3,  5, 12,  6,  4,  5, 14,  0<span class=o>]])</span>&gt;, &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1375, <span class=nv>shape</span><span class=o>=(</span>2, 3<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span>4, 7, 3<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span>4, 8, 3<span class=o>]])</span>&gt;, &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1376, <span class=nv>shape</span><span class=o>=(</span>2, 2<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span> 8, 11<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span>12,  0<span class=o>]])</span>&gt;<span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=m>3</span> <span class=o>(</span>&lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1380, <span class=nv>shape</span><span class=o>=(</span>2, 8<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span> 4,  5, 15,  6,  3,  5,  8, 11<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span> 4,  5, 10,  6,  3,  5, 19,  0<span class=o>]])</span>&gt;, &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1381, <span class=nv>shape</span><span class=o>=(</span>2, 3<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span>4, 9, 3<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span>3, 7, 4<span class=o>]])</span>&gt;, &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1382, <span class=nv>shape</span><span class=o>=(</span>2, 2<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span> 8, 15<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span>19,  0<span class=o>]])</span>&gt;<span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=m>4</span> <span class=o>(</span>&lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1386, <span class=nv>shape</span><span class=o>=(</span>2, 8<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span> 4,  5, 12,  6,  3,  5, 10,  0<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span> 4,  5, 19,  6,  3,  5,  8, 17<span class=o>]])</span>&gt;, &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1387, <span class=nv>shape</span><span class=o>=(</span>2, 3<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span>4, 8, 3<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span>3, 9, 4<span class=o>]])</span>&gt;, &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1388, <span class=nv>shape</span><span class=o>=(</span>2, 3<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span>12,  0,  0<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span> 8, 16, 13<span class=o>]])</span>&gt;<span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=m>5</span> <span class=o>(</span>&lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1392, <span class=nv>shape</span><span class=o>=(</span>2, 8<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span> 4,  5,  8, 13,  6,  3,  5, 17<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span> 4,  5, 10,  6,  3,  5, 14,  0<span class=o>]])</span>&gt;, &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1393, <span class=nv>shape</span><span class=o>=(</span>2, 3<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span>4, 7, 3<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span>3, 9, 4<span class=o>]])</span>&gt;, &lt;tf.Tensor: <span class=nv>id</span><span class=o>=</span>1394, <span class=nv>shape</span><span class=o>=(</span>2, 1<span class=o>)</span>, <span class=nv>dtype</span><span class=o>=</span>int64, <span class=nv>numpy</span><span class=o>=</span>
</span></span><span class=line><span class=cl>  array<span class=o>([[</span>14<span class=o>]</span>,
</span></span><span class=line><span class=cl>         <span class=o>[</span>10<span class=o>]])</span>&gt;<span class=o>)</span>
</span></span></code></pre></div><p>As preparation for the subsequent blogs, let&rsquo;s generate a more substantial data source with 10 shards of 1,000 samples each:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>ps</span><span class=o>.</span><span class=n>max_val</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=n>ps</span><span class=o>.</span><span class=n>num_samples</span> <span class=o>=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=n>ps</span><span class=o>.</span><span class=n>num_shards</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=n>fs</span> <span class=o>=</span> <span class=p>[</span><span class=n>f</span> <span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>dump</span><span class=p>(</span><span class=n>ps</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>ps</span><span class=o>.</span><span class=n>dim_batch</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>load</span><span class=p>(</span><span class=n>ps</span><span class=p>,</span> <span class=n>fs</span><span class=p>)</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>adapter</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  dumping /tmp/q/dataset/shard_0000.tfrecords...
</span></span><span class=line><span class=cl>  dumping /tmp/q/dataset/shard_0001.tfrecords...
</span></span><span class=line><span class=cl>  dumping /tmp/q/dataset/shard_0002.tfrecords...
</span></span><span class=line><span class=cl>  dumping /tmp/q/dataset/shard_0003.tfrecords...
</span></span><span class=line><span class=cl>  dumping /tmp/q/dataset/shard_0004.tfrecords...
</span></span><span class=line><span class=cl>  dumping /tmp/q/dataset/shard_0005.tfrecords...
</span></span><span class=line><span class=cl>  dumping /tmp/q/dataset/shard_0006.tfrecords...
</span></span><span class=line><span class=cl>  dumping /tmp/q/dataset/shard_0007.tfrecords...
</span></span><span class=line><span class=cl>  dumping /tmp/q/dataset/shard_0008.tfrecords...
</span></span><span class=line><span class=cl>  dumping /tmp/q/dataset/shard_0009.tfrecords...
</span></span><span class=line><span class=cl>  <span class=m>99</span>
</span></span></code></pre></div><p>This concludes our blog, please see how easy masking our uneven sample &ldquo;lines&rdquo; can be by clicking on the next blog.</p></div></main></div><footer class="qal-footer py-5 bg-light"><div class=container><div class=row><div class=col-lg><a class=d-inline-flex href=../../><svg xmlns="http://www.w3.org/2000/svg" width="40" height="32" class="d-block me-2" viewBox="0 0 118 94" role="img"><title>Silcrow</title><path d="m67.476567 58.848956q2.916668 2.114585 4.375002 4.812503t1.458334 5.942711q0 5.250002-4.520836 8.421879-4.520835 3.208335-10.60938 3.208335-5.541669.0-9.406254-2.552085-3.864586-2.552084-3.864586-6.270836.0-2.151043 1.421876-3.500002 1.421876-1.3125 3.208335-1.3125 1.932293.0 3.026043 1.09375 1.093751 1.130209 1.786459 3.609377.911459 3.09896 2.296876 3.97396 1.385418.911459 3.208335.911459 2.187501.0 3.75521-1.239584t1.567709-3.026043q0-1.458334-1.020833-3.135418-1.057293-1.640626-6.708337-5.468753-6.526045-4.375002-9.369796-6.781253-2.843751-2.44271-4.375002-5.322919-1.531251-2.916669-1.531251-6.19792.0-3.09896 1.348959-5.432294 1.385417-2.333335 3.208335-3.427085 1.822918-1.130209 4.302085-1.713543-3.098959-2.260418-4.666668-4.921877-1.56771-2.66146-1.56771-5.76042.0-5.322919 4.484378-8.640629 4.484377-3.354168 10.901046-3.354168 5.395836.0 9.333338 2.515626t3.937502 6.088545q0 2.114584-1.494792 3.463543-1.494793 1.348959-3.427085 1.348959-1.895834.0-2.843752-.984375-.947917-1.020834-1.859376-3.718752-.838542-2.552085-2.078125-3.609377-1.239584-1.057292-3.463544-1.057292-2.296876.0-3.937502 1.276042-1.604167 1.276043-1.604167 3.062502.0 2.041667 1.567709 3.682293 1.531251 1.640626 7.473962 5.432294 5.578128 3.572919 8.239587 5.76042 2.697918 2.151043 4.229169 5.140627 1.567709 2.989585 1.567709 6.453128.0 4.411461-2.078126 7.218754-2.078126 2.807293-6.270836 4.010418zm1.166667-7.000003q0-3.682293-6.234378-8.531254-6.19792-4.885419-9.187505-4.885419-1.385417.0-2.661459 1.09375-1.239584 1.057293-1.239584 2.515627.0 3.463543 6.307295 8.421879 6.343753 4.958335 9.260421 4.958335 1.53125.0 2.625001-1.057292 1.130209-1.057292 1.130209-2.515626z" fill="#0"/></svg><span class=fs-5>&copy; 2022 Qnarre</span></a><ul class="list-unstyled small text-muted"><li class=mb-2>Software is our passion.</li></ul></div></div></div></footer><script src=../../js/bootstrap.bundle.min.js></script>
<script src=../../js/script.min.js></script></body></html>
<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A quick narrative analyzer for &lsquo;bipolar&rsquo; text"><meta name=author content="Qnarre - Software is our passion"><meta name=generator content="Hugo 0.101.0"><meta name=docsearch:language content="en"><meta name=docsearch:version content="0.1.0"><title>Psychological Non-Profiles Of American Bar &ldquo;Frequent Fliers&rdquo; Â· Qnarre</title><link rel=canonical href=https://quantapix.github.io/modeling/objects/><link href=../../css/bootstrap.min.css rel=stylesheet><link href=../../css/style.css rel=stylesheet><link rel=apple-touch-icon href=../../img/favs/apple-touch-icon.png sizes=180x180><link rel=icon href=../../img/favs/favicon-32x32.png sizes=32x32 type=image/png><link rel=icon href=../../img/favs/favicon-16x16.png sizes=16x16 type=image/png><link rel=manifest href=../../img/favs/manifest.json><link rel=mask-icon href=../../img/favs/safari-pinned-tab color=#7952b3><link rel=icon href=../../img/favs/favicon.ico><meta name=theme-color content="#7952b3"></head><body><div class="skippy visually-hidden-focusable overflow-hidden"><div class=container-xl><a class="d-inline-flex p-2 m-1" href=#content>Skip to content</a></div></div><header class="navbar navbar-expand-md navbar-dark qal-navbar"><nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-2" href=../../><svg xmlns="http://www.w3.org/2000/svg" width="40" height="32" class="d-block my-1" viewBox="0 0 118 94" role="img"><title>Silcrow</title><path d="m67.476567 58.848956q2.916668 2.114585 4.375002 4.812503t1.458334 5.942711q0 5.250002-4.520836 8.421879-4.520835 3.208335-10.60938 3.208335-5.541669.0-9.406254-2.552085-3.864586-2.552084-3.864586-6.270836.0-2.151043 1.421876-3.500002 1.421876-1.3125 3.208335-1.3125 1.932293.0 3.026043 1.09375 1.093751 1.130209 1.786459 3.609377.911459 3.09896 2.296876 3.97396 1.385418.911459 3.208335.911459 2.187501.0 3.75521-1.239584t1.567709-3.026043q0-1.458334-1.020833-3.135418-1.057293-1.640626-6.708337-5.468753-6.526045-4.375002-9.369796-6.781253-2.843751-2.44271-4.375002-5.322919-1.531251-2.916669-1.531251-6.19792.0-3.09896 1.348959-5.432294 1.385417-2.333335 3.208335-3.427085 1.822918-1.130209 4.302085-1.713543-3.098959-2.260418-4.666668-4.921877-1.56771-2.66146-1.56771-5.76042.0-5.322919 4.484378-8.640629 4.484377-3.354168 10.901046-3.354168 5.395836.0 9.333338 2.515626t3.937502 6.088545q0 2.114584-1.494792 3.463543-1.494793 1.348959-3.427085 1.348959-1.895834.0-2.843752-.984375-.947917-1.020834-1.859376-3.718752-.838542-2.552085-2.078125-3.609377-1.239584-1.057292-3.463544-1.057292-2.296876.0-3.937502 1.276042-1.604167 1.276043-1.604167 3.062502.0 2.041667 1.567709 3.682293 1.531251 1.640626 7.473962 5.432294 5.578128 3.572919 8.239587 5.76042 2.697918 2.151043 4.229169 5.140627 1.567709 2.989585 1.567709 6.453128.0 4.411461-2.078126 7.218754-2.078126 2.807293-6.270836 4.010418zm1.166667-7.000003q0-3.682293-6.234378-8.531254-6.19792-4.885419-9.187505-4.885419-1.385417.0-2.661459 1.09375-1.239584 1.057293-1.239584 2.515627.0 3.463543 6.307295 8.421879 6.343753 4.958335 9.260421 4.958335 1.53125.0 2.625001-1.057292 1.130209-1.057292 1.130209-2.515626z" fill="#fff"/></svg></a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#qalNavbar aria-controls=qalNavbar aria-expanded=false aria-label="Toggle navigation"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" class="bi" fill="currentcolor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 11.5A.5.5.0 013 11h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5zm0-4A.5.5.0 013 7h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5zm0-4A.5.5.0 013 3h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5z"/></svg></button><div class="collapse navbar-collapse" id=qalNavbar><hr class="d-md-none text-white-50"><ul class="navbar-nav flex-row flex-wrap qal-navbar-nav"><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../>Qnarre</a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2 active" aria-current=true href=../../modeling/>Modeling</a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../semantics/>Semantics</a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../analytics/>Analytics</a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../reports/>Reports</a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=../../story/>The Story</a></li></ul><hr class="d-md-none text-white-50"><ul class="navbar-nav flex-row flex-wrap ms-md-auto"><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=https://twitter.com/ikifor target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" class="navbar-nav-svg d-inline-block align-text-top" viewBox="0 0 512 416.32" role="img"><title>Twitter</title><path fill="currentcolor" d="M160.83 416.32c193.2.0 298.92-160.22 298.92-298.92.0-4.51.0-9-.2-13.52A214 214 0 00512 49.38a212.93 212.93.0 01-60.44 16.6 105.7 105.7.0 0046.3-58.19 209 209 0 01-66.79 25.37 105.09 105.09.0 00-181.73 71.91 116.12 116.12.0 002.66 24c-87.28-4.3-164.73-46.3-216.56-109.82A105.48 105.48.0 0068 159.6a106.27 106.27.0 01-47.53-13.11v1.43a105.28 105.28.0 0084.21 103.06 105.67 105.67.0 01-47.33 1.84 105.06 105.06.0 0098.14 72.94A210.72 210.72.0 0125 370.84a202.17 202.17.0 01-25-1.43 298.85 298.85.0 00160.83 46.92"/></svg><small class="d-md-none ms-2">Twitter</small></a></li><li class="nav-item col-6 col-md-auto"><a class="nav-link p-2" href=https://github.com/quantapix target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" class="navbar-nav-svg d-inline-block align-text-top" viewBox="0 0 512 499.36" role="img"><title>GitHub</title><path fill="currentcolor" fill-rule="evenodd" d="M256 0C114.64.0.0 114.61.0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34.0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49.0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75.0.0 21.49-6.88 70.4 26.24a242.65 242.65.0 01128.18.0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69.0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41.0 34.22-.31 61.83-.31 70.23.0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37.0 256 0z"/></svg><small class="d-md-none ms-2">GitHub</small></a></li></ul><a class="btn btn-qal-download d-lg-inline-block my-2 my-md-0 ms-md-3" href=../../simlaw/>SimLaw.app</a></div></nav></header><div class="container-xxl my-md-4 qal-layout"><aside class=qal-sidebar><nav class="collapse qal-links" id=qal-docs-nav aria-label="Nav links"><ul class="list-unstyled mb-0 py-3 pt-md-1"><li class=mb-1><button class="btn d-inline-flex align-items-center rounded" data-bs-toggle=collapse data-bs-target=#modeling-collapse aria-expanded=true aria-current=true>
Modeling</button><div class="collapse show" id=modeling-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../modeling/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../modeling/simulation class="d-inline-flex align-items-center rounded">Judicial Simulation</a></li><li><a href=../../modeling/concepts class="d-inline-flex align-items-center rounded">Conceptual Model</a></li><li><a href=../../modeling/report class="d-inline-flex align-items-center rounded">Sample Report</a></li></ul></div></li><li class=mb-1><button class="btn d-inline-flex align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#semantics-collapse aria-expanded=false>
Semantics</button><div class=collapse id=semantics-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../semantics/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../semantics/simulation class="d-inline-flex align-items-center rounded">Judicial Simulation</a></li><li><a href=../../semantics/concepts class="d-inline-flex align-items-center rounded">Conceptual Model</a></li></ul></div></li><li class=mb-1><button class="btn d-inline-flex align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#analytics-collapse aria-expanded=false>
Analytics</button><div class=collapse id=analytics-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../analytics/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../analytics/prepare class="d-inline-flex align-items-center rounded">Preparing Documents</a></li><li><a href=../../analytics/extract class="d-inline-flex align-items-center rounded">Extracting Narratives</a></li><li><a href=../../analytics/output class="d-inline-flex align-items-center rounded">Standardized Output</a></li><li><a href=../../analytics/graph class="d-inline-flex align-items-center rounded">Conflict Graph</a></li><li><a href=../../analytics/analyze class="d-inline-flex align-items-center rounded">Irrefutable Analytics</a></li></ul></div></li><li class=mb-1><button class="btn d-inline-flex align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#reports-collapse aria-expanded=false>
Reports</button><div class=collapse id=reports-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../reports/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../reports/prepare class="d-inline-flex align-items-center rounded">Generating Reports</a></li></ul></div></li><li class=mb-1><button class="btn d-inline-flex align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#story-collapse aria-expanded=false>
The Story</button><div class=collapse id=story-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../story/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../story/about class="d-inline-flex align-items-center rounded">About</a></li><li><a href=../../story/blog class="d-inline-flex align-items-center rounded">Blog</a></li></ul></div></li><li class=mb-1><button class="btn d-inline-flex align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#tech-collapse aria-expanded=false>
Available Tech</button><div class=collapse id=tech-collapse><ul class="list-unstyled fw-normal pb-1 small"><li><a href=../../tech/./ class="d-inline-flex align-items-center rounded">Overview</a></li><li><a href=../../tech/trackable class="d-inline-flex align-items-center rounded">Trackable Persistence</a></li><li><a href=../../tech/gpus class="d-inline-flex align-items-center rounded">Many Smaller GPUs</a></li><li><a href=../../tech/dataset class="d-inline-flex align-items-center rounded">Datasets</a></li><li><a href=../../tech/masking class="d-inline-flex align-items-center rounded">Unified Masking</a></li><li><a href=../../tech/ragged class="d-inline-flex align-items-center rounded">Ragged Tensors</a></li><li><a href=../../tech/layers class="d-inline-flex align-items-center rounded">Layers Simplified</a></li><li><a href=../../tech/custom class="d-inline-flex align-items-center rounded">Custom Layers</a></li><li><a href=../../tech/autograph class="d-inline-flex align-items-center rounded">Autograph</a></li><li><a href=../../tech/metrics class="d-inline-flex align-items-center rounded">Modular Metrics</a></li><li><a href=../../tech/callbacks class="d-inline-flex align-items-center rounded">Extended Callbacks</a></li></ul></div></li></ul></nav></aside><main class="qal-main order-1"><div class="qal-intro ps-lg-4"><div class="d-md-flex flex-md-row align-items-center justify-content-between"><h1 class=qal-title id=content>Psychological Non-Profiles Of American Bar &ldquo;Frequent Fliers&rdquo;</h1></div><p class=qal-lead></p></div><div class="qal-toc mt-4 mb-5 my-md-0 ps-xl-3 mb-lg-5 text-muted"><strong class="d-block h6 my-2 pb-2 border-bottom">On this page</strong><nav id=TableOfContents><ul><li><a href=#indirect-contradictions-and-conflicts>Indirect contradictions and conflicts</a></li><li><a href=#model-definition-and-configuration>Model definition and configuration</a></li><li><a href=#frames-revisited>Frames revisited</a></li><li><a href=#input-signature-optimization>&ldquo;Input signature&rdquo; optimization</a></li><li><a href=#deduce-layer>Deduce layer</a></li></ul></nav></div><div class="qal-content ps-lg-4"><p>The American &ldquo;Divorce Corp.&rdquo; is an alleged ~$50B+ <a href=https://www.divorcecorp.com/>&ldquo;industry&rdquo;</a>. As with any current &ldquo;be stunned, be shocked and pay attention to me&rdquo; activist movement, it is hard to know what is true and what is for-profit manipulation behind the linked movie.</p><p>Nevertheless, the American Bar Association, Section of Family Law, seemingly acknowledges the existence of <a href=https://www.americanbar.org/content/dam/aba/events/family_law/2014/05/section_of_familylawspringcleconference/11_fri_custody.authcheckdam.pdf>&ldquo;frequent fliers&rdquo;</a>, as the effectively and reliably &ldquo;churning&rdquo; 10%, the <strong>astronomically profitable &ldquo;high-conflict&rdquo; 10%</strong>, of their overall yearly &ldquo;business&rdquo;.</p><p><em>Quiz: When more than half of American families get divorced and the ABA-licensed/protected lawyers literally and endlessly &ldquo;milk&rdquo; 10% of those cases for a profit of ~$50B / year, how many innocent and endlessly tortured American children does that involve?</em></p><p>Sadly, the ABA and the lawyers also acknowledge that this profitable business of theirs is <strong>chronically and sadistically child abusive</strong>. Nevertheless, perhaps inspired by the <a href=https://en.wikipedia.org/wiki/Fundamental_theorem_of_software_engineering>Fundamental Theorem of Software Engineering</a>, the &ldquo;elite&rdquo; child abusive lawyers quickly learned that &ldquo;we can solve any problem by introducing an extra level of indirection&rdquo;.</p><p>And they started to formally, with the ABA&rsquo;s apparent blessing, blame their victims, the confused, but otherwise clearly capable and well-off-by-necessity parents, with woo-doo science sound-bites: <em>&ldquo;the parents in conflict tend to be more preoccupied with their own identity reconstruction&rdquo;</em>.</p><p>And per the always successful &ldquo;indirection&rdquo; strategy of avoiding blame, they formed a mutually beneficial alliance with the:</p><ul><li>&ldquo;no skin in the game&rdquo;, i.e. <a href=https://en.wikipedia.org/wiki/Hippocratic_Oath><strong>not a medical doctor</strong></a>,</li><li>&ldquo;science sounding dogma&rdquo;, i.e. <a href=https://www.theatlantic.com/science/archive/2018/11/psychologys-replication-crisis-real/576223/><strong>not scientifically repeatable</strong>, reproducible nor falsifiable</a> and</li><li>hence <a href="https://www.law.com/ctlawtribune/2019/01/14/absolute-immunity-shields-lawyer-sued-over-guardian-ad-litem-role-appeals-court-rules/?slreturn=20190627150712"><strong>&ldquo;absolute judicial immunity&rdquo;</strong></a> practitioners.</li></ul><p>Namely, the lawyers work seemingly exclusively with Guardian Ad Litems and/or psychologists. Specifically, they work with the psychologists who have a license, with seemingly absolutely no oversight, to arbitrarily and maliciously profile <a href=https://owlcation.com/social-sciences/What-Judges-Need-to-Know-About-Narcissistic-Personality-Disorder-in-Custody-Cases>half of society</a> with indefensible allegations, i.e. dogmatic scare-tactics and ruthlessly child abusive manipulations.</p><p>Supported by the ABA-sponsored &ldquo;frequent flier&rdquo; label, the psychologists claim: <em>&ldquo;The NPD will bring a plethora of legal actions that barely make sense or are fully nonsense. They will often burn through attorneys. They will have a history of multiple PFAâs against them. <strong>If they are male (and most are)</strong>, they may have multiple custody issues with multiple women.&rdquo;</em></p><p>Once you control the psychology, you control the person just as Joseph Stalin&rsquo;s associate claimed <a href=https://www.cato.org/policy-report/januaryfebruary-2010/criminalization-almost-everything><strong>&ldquo;Show me the man and Iâll find you the crime&rdquo;</strong></a>: <em>&ldquo;In his foreword to my book, Alan Dershowitz discusses his time litigating cases in the old Soviet Union. He was always taken by the fact that they could prosecute anybody they wanted because some of the statutes were so vague&rdquo;</em>.</p><h2 id=indirect-contradictions-and-conflicts>Indirect contradictions and conflicts</h2><p>Finally getting back to our blog, we now focus on <strong>indirectly</strong> &ldquo;fabricated conflicts&rdquo;. Our second goal is to train our computer to &ldquo;catch a chain of falsities&rdquo; by systematically finding indirect, through a second arithmetic expression in this blog, irrefutable textual contradictions in our inputs.</p><p>Once again, we have already too much accumulated code to load into our notebook. For your reference, we sample from the attached local source files: <em>datasets.py, layers.py, main.py, modules.py, samples.py, tasks.py, trafo.py</em> and <em>utils.py</em>.</p><p>Our previous blog has already generated the necessary <code>small</code> set of samples.</p><p>If you have not run the code yet, please follow that blog to generate samples. You will get an error if you attempt to run this code without available samples.</p><p>In this blog we focus on <code>yes-no-extended</code> (YNX) and <code>masked-extended</code> (MSX) samples. Here is how we can generate a few samples:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>samples</span> <span class=k>as</span> <span class=nn>qs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>groups</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=s1>&#39;yns ynx msk msx cls clx qas rev gen fix&#39;</span><span class=o>.</span><span class=n>split</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>YNS</span><span class=p>,</span> <span class=n>YNX</span><span class=p>,</span> <span class=n>MSK</span><span class=p>,</span> <span class=n>MSX</span><span class=p>,</span> <span class=n>CLS</span><span class=p>,</span> <span class=n>CLX</span><span class=p>,</span> <span class=n>QAS</span><span class=p>,</span> <span class=n>REV</span><span class=p>,</span> <span class=n>GEN</span><span class=p>,</span> <span class=n>FIX</span> <span class=o>=</span> <span class=n>groups</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>utils</span> <span class=k>as</span> <span class=nn>qu</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ps</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>dim_pool</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>max_val</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>num_samples</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ps</span> <span class=o>=</span> <span class=n>qu</span><span class=o>.</span><span class=n>Params</span><span class=p>(</span><span class=o>**</span><span class=n>ps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>qs</span><span class=o>.</span><span class=n>sampler</span><span class=p>(</span><span class=n>ps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>d</span><span class=p>[</span><span class=n>YNX</span><span class=p>]</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>d</span><span class=p>[</span><span class=n>MSX</span><span class=p>]</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>  <span class=o>{</span><span class=s1>&#39;enc&#39;</span>: <span class=s1>&#39;x=-35,y=-64;y-x[-29]&#39;</span>, <span class=s1>&#39;dec&#39;</span>: <span class=s1>&#39;y=-7,x=$;y-x[22]|_&#39;</span>, <span class=s1>&#39;tgt&#39;</span>: <span class=s1>&#39;y=-7,x=$;y-x[22]|1&#39;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>{</span><span class=s1>&#39;enc&#39;</span>: <span class=s1>&#39;x=-35,y=-64;y-x[-29]&#39;</span>, <span class=s1>&#39;dec&#39;</span>: <span class=s1>&#39;y=-7,x??????[2?]|&#39;</span>, <span class=s1>&#39;tgt&#39;</span>: <span class=s1>&#39;y=-7,x=$;y-x[22]|&#39;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>{</span><span class=s1>&#39;enc&#39;</span>: <span class=s1>&#39;y=40,x=23;x-y[-17]&#39;</span>, <span class=s1>&#39;dec&#39;</span>: <span class=s1>&#39;y=-61,x=$;x-y[62]|_&#39;</span>, <span class=s1>&#39;tgt&#39;</span>: <span class=s1>&#39;y=-61,x=$;x-y[44]|0&#39;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>{</span><span class=s1>&#39;enc&#39;</span>: <span class=s1>&#39;y=40,x=23;x-y[-17]&#39;</span>, <span class=s1>&#39;dec&#39;</span>: <span class=s1>&#39;?=?61?x?$?x-?[?4]|&#39;</span>, <span class=s1>&#39;tgt&#39;</span>: <span class=s1>&#39;y=-61,x=$;x-y[44]|&#39;</span><span class=o>}</span>
</span></span></code></pre></div><p>We only show the YNX and MSX groups of samples. They are similar to our previous YNS and MSK samples in objective.</p><p>Their scope is expanded however. The YNX samples introduce &ldquo;indirection&rdquo; into the learned, inherent &ldquo;knowledge&rdquo; as it uses 2 expressions, the second one building on, or reusing, the first one&rsquo;s result.</p><p>Either of the expressions&rsquo; results can be incorrect. And after training, the computer will have to effectively perform chained deduction to get the <code>yes-no</code> answer right.</p><p>The MSX samples also two expressions. And instead of <code>masking</code> only a homogenous result, these samples randomly mask the entire second expression.</p><p>As the masked expression uses the result of the first one, the above mentioned &ldquo;indirection&rdquo; is once again in play.</p><h2 id=model-definition-and-configuration>Model definition and configuration</h2><p>We have mentioned already that we are largely reusing the model, specifically its layers and modules, from the first section of our blogs.</p><p>In this blog we provide more details of the necessary changes in the layers.</p><p>We start with a significant change in our <code>Layer</code> base-class, as we have started to support the Keras <code>get_config</code> method. We are now able to recreate our layers from checkpoints.</p><p>In <code>utils.py</code> we extend our <code>Params</code> class with a new <code>Config</code> class that encapsulates the actually persisted param values:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Params</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>**</span><span class=n>kw</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>kw</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=nb>setattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>cfg_items</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>keys</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>keys</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>k</span><span class=p>,</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>k</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Config</span><span class=p>(</span><span class=n>Params</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>runtime</span> <span class=o>=</span> <span class=n>Params</span><span class=p>(</span><span class=n>is_training</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>print_toks</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>**</span><span class=n>kw</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=o>**</span><span class=n>kw</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_items</span> <span class=o>=</span> <span class=n>kw</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>items</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_items</span>
</span></span></code></pre></div><p>Using our new <code>Config</code>, we add support for the Keras &ldquo;config&rdquo; mechanism in <code>Layer</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tensorflow</span> <span class=k>as</span> <span class=nn>tf</span>
</span></span><span class=line><span class=cl><span class=n>ks</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span>
</span></span><span class=line><span class=cl><span class=n>ki</span> <span class=o>=</span> <span class=n>ks</span><span class=o>.</span><span class=n>initializers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Layer</span><span class=p>(</span><span class=n>ks</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Layer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>initer</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>cfg_items</span><span class=p>(</span><span class=n>ps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>yield from</span> <span class=n>ps</span><span class=o>.</span><span class=n>cfg_items</span><span class=p>(</span><span class=s1>&#39;initer_stddev&#39;</span><span class=p>,</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>from_config</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>cfg</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>cls</span><span class=p>(</span><span class=n>qu</span><span class=o>.</span><span class=n>Config</span><span class=p>(</span><span class=o>**</span><span class=n>cfg</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ps</span><span class=p>,</span> <span class=o>**</span><span class=n>kw</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>kw</span><span class=o>.</span><span class=n>setdefault</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=n>qu</span><span class=o>.</span><span class=n>to_snake_case</span><span class=p>(</span><span class=nb>type</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=vm>__name__</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>kw</span><span class=o>.</span><span class=n>setdefault</span><span class=p>(</span><span class=s1>&#39;dtype&#39;</span><span class=p>,</span> <span class=n>tf</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=o>**</span><span class=n>kw</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>ps</span><span class=p>,</span> <span class=n>qu</span><span class=o>.</span><span class=n>Config</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cfg</span> <span class=o>=</span> <span class=n>ps</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cfg</span> <span class=o>=</span> <span class=n>qu</span><span class=o>.</span><span class=n>Config</span><span class=p>(</span><span class=o>**</span><span class=nb>dict</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>cfg_items</span><span class=p>(</span><span class=n>ps</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>cfg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cfg</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cfg</span><span class=o>.</span><span class=n>initer_stddev</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>initer</span> <span class=o>=</span> <span class=n>ki</span><span class=o>.</span><span class=n>TruncatedNormal</span><span class=p>(</span><span class=n>stddev</span><span class=o>=</span><span class=n>cfg</span><span class=o>.</span><span class=n>initer_stddev</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_config</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>get_config</span><span class=p>()</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cfg</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>dict</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>b</span><span class=p>)</span> <span class=o>+</span> <span class=nb>list</span><span class=p>(</span><span class=n>c</span><span class=p>))</span>
</span></span></code></pre></div><h2 id=frames-revisited>Frames revisited</h2><p>To demonstrate how only necessary params get saved for each layer, we provide a fragment of the already presented <code>Frames</code> class below.</p><p>The rest of the class, as well as the derived <code>Tokens</code> and <code>Meta</code> classes are mostly unchanged.</p><p>The only significant difference is that we have started to use the attached instance of the <code>Config</code> class instead of the previously used bare <code>Params</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Frames</span><span class=p>(</span><span class=n>Layer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>ps</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>int32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>cfg</span><span class=o>.</span><span class=n>dim_batch</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>cfg</span><span class=o>.</span><span class=n>width_enc</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>kw</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span><span class=n>initializer</span><span class=o>=</span><span class=s1>&#39;zeros&#39;</span><span class=p>,</span> <span class=n>trainable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>use_resource</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>prev</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>add_weight</span><span class=p>(</span><span class=s1>&#39;prev&#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=o>**</span><span class=n>kw</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>cfg_items</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>yield from</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>cfg_items</span><span class=p>(</span><span class=n>ps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>yield from</span> <span class=n>ps</span><span class=o>.</span><span class=n>cfg_items</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;dim_batch&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;dim_hist&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;width_dec&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;width_enc&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span></code></pre></div><h2 id=input-signature-optimization>&ldquo;Input signature&rdquo; optimization</h2><p>Another addition to the layers in this blog is the addition of <code>input_signatures</code> to the <code>call</code> methods&rsquo; <code>tf.function</code> definitions.</p><p>Since we keep a tight control of the shapes of our &ldquo;transfer&rdquo; tensors, there is no need for TF to unnecessarily generate Python code.</p><p>We provide the partial <code>Decode</code> class example to illustrate this addition:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Decode</span><span class=p>(</span><span class=n>Layer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nd>@tf</span><span class=o>.</span><span class=n>function</span><span class=p>(</span><span class=n>input_signature</span><span class=o>=</span><span class=p>[[</span>
</span></span><span class=line><span class=cl>        <span class=n>tf</span><span class=o>.</span><span class=n>TensorSpec</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>        <span class=n>tf</span><span class=o>.</span><span class=n>TensorSpec</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=kc>None</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>int32</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>tf</span><span class=o>.</span><span class=n>TensorSpec</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>]])</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span><span class=p>,</span> <span class=n>ye</span> <span class=o>=</span> <span class=n>x</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=n>x</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>dec</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>decs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>y</span> <span class=o>=</span> <span class=n>dec</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=p>[</span><span class=n>ye</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>y</span>
</span></span></code></pre></div><h2 id=deduce-layer>Deduce layer</h2><p>We have also added a new layer to specifically help with the MSK and MSX samples.</p><p>The new <code>Deduce</code> layer provides us with a graph op to conditionally loop through all the masked, by the <code>?</code> token, input positions and one-by-one deduce the target tokens.</p><p>The loops obviously are driven by the actual number of masked positions in the individual batches of samples. So loop control needs to be executed by the synthesized graph op.</p><p>A partial definition of the class follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Deduce</span><span class=p>(</span><span class=n>Layer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ps</span><span class=p>,</span> <span class=n>embed</span><span class=p>,</span> <span class=n>decode</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>ps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>embed</span> <span class=o>=</span> <span class=n>embed</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>decode</span> <span class=o>=</span> <span class=n>decode</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>cfg</span><span class=o>.</span><span class=n>dim_hidden</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>cfg</span><span class=o>.</span><span class=n>dim_vocab</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>inflate</span> <span class=o>=</span> <span class=n>qm</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s1>&#39;inflate&#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@tf</span><span class=o>.</span><span class=n>function</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>toks</span><span class=p>,</span> <span class=o>*</span><span class=n>x</span> <span class=o>=</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>cfg</span><span class=o>.</span><span class=n>runtime</span><span class=o>.</span><span class=n>print_toks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>qu</span><span class=o>.</span><span class=n>print_toks</span><span class=p>(</span><span class=n>toks</span><span class=p>,</span> <span class=n>qd</span><span class=o>.</span><span class=n>vocab</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>deduce</span><span class=p>([</span><span class=n>toks</span><span class=p>]</span> <span class=o>+</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>n</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>y</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>toks</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>tf</span><span class=o>.</span><span class=n>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span> <span class=o>=</span> <span class=n>toks</span><span class=p>[:,</span> <span class=p>:</span><span class=n>n</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>m</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>equal</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>qd</span><span class=o>.</span><span class=n>MSK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>tf</span><span class=o>.</span><span class=n>equal</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>reduce_any</span><span class=p>(</span><span class=n>m</span><span class=p>),</span> <span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>t</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>m</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>cfg</span><span class=o>.</span><span class=n>runtime</span><span class=o>.</span><span class=n>print_toks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>qu</span><span class=o>.</span><span class=n>print_toks</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>qd</span><span class=o>.</span><span class=n>vocab</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>toks</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>pad</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=p>[[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=n>p</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>                <span class=n>y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>deduce</span><span class=p>([</span><span class=n>toks</span><span class=p>]</span> <span class=o>+</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>equal</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>qd</span><span class=o>.</span><span class=n>EOS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>math</span><span class=o>.</span><span class=n>count_nonzero</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>tf</span><span class=o>.</span><span class=n>equal</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>reduce_any</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>not_equal</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=mi>1</span><span class=p>)),</span> <span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>y</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>deduce</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>embed</span><span class=p>(</span><span class=n>x</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span><span class=p>,</span> <span class=n>lens</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=n>x</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>inflate</span><span class=p>(</span><span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>RaggedTensor</span><span class=o>.</span><span class=n>from_tensor</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>lens</span><span class=p>)</span><span class=o>.</span><span class=n>to_tensor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>y</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>update</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>toks</span><span class=p>,</span> <span class=n>msks</span><span class=p>,</span> <span class=n>ctx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>cast</span><span class=p>(</span><span class=n>msks</span><span class=p>,</span> <span class=n>tf</span><span class=o>.</span><span class=n>int32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>output_type</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>int32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>n</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>msks</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>stack</span><span class=p>([</span><span class=n>tf</span><span class=o>.</span><span class=n>range</span><span class=p>(</span><span class=n>n</span><span class=p>),</span> <span class=n>i</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>m</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>zeros_like</span><span class=p>(</span><span class=n>msks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>m</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>tensor_scatter_nd_update</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>tf</span><span class=o>.</span><span class=n>ones</span><span class=p>([</span><span class=n>n</span><span class=p>],</span> <span class=n>tf</span><span class=o>.</span><span class=n>bool</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>boolean_mask</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>math</span><span class=o>.</span><span class=n>log_softmax</span><span class=p>(</span><span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>axis</span><span class=o>=-</span><span class=mi>1</span><span class=p>,</span> <span class=n>output_type</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>int32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>tensor_scatter_nd_update</span><span class=p>(</span><span class=n>toks</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>logical_and</span><span class=p>(</span><span class=n>msks</span><span class=p>,</span> <span class=n>m</span><span class=p>),</span> <span class=n>y</span><span class=p>,</span> <span class=n>toks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>y</span>
</span></span></code></pre></div><p>The code above depends on references to the <code>embed</code> and <code>decode</code> layers, as it has to actively a) <code>deduce</code> the new token and b) &ldquo;re-decode&rdquo; the context in the <code>update</code> method.</p><p>The loop is initially set to execute for every token in the width of the input context.</p><p>Nevertheless, if there are no <code>qd.MSK</code>, or &ldquo;?&rdquo;, tokens and we have reached our <code>qd.EOS</code>, or &ldquo;|&rdquo;, token for every row on the batch, we end the loop.</p><p>With these changes in the code, we can adjust the groups of samples we want to train on, to YNX and MSX, and run the previously presented steps. We skip re-running the training sessions until the last &ldquo;unifying&rdquo; blog in this section.</p><p>This concludes our blog, please click on the next blog for further details of the additional changes.</p></div></main></div><footer class="qal-footer py-5 bg-light"><div class=container><div class=row><div class=col-lg><a class=d-inline-flex href=../../><svg xmlns="http://www.w3.org/2000/svg" width="40" height="32" class="d-block me-2" viewBox="0 0 118 94" role="img"><title>Silcrow</title><path d="m67.476567 58.848956q2.916668 2.114585 4.375002 4.812503t1.458334 5.942711q0 5.250002-4.520836 8.421879-4.520835 3.208335-10.60938 3.208335-5.541669.0-9.406254-2.552085-3.864586-2.552084-3.864586-6.270836.0-2.151043 1.421876-3.500002 1.421876-1.3125 3.208335-1.3125 1.932293.0 3.026043 1.09375 1.093751 1.130209 1.786459 3.609377.911459 3.09896 2.296876 3.97396 1.385418.911459 3.208335.911459 2.187501.0 3.75521-1.239584t1.567709-3.026043q0-1.458334-1.020833-3.135418-1.057293-1.640626-6.708337-5.468753-6.526045-4.375002-9.369796-6.781253-2.843751-2.44271-4.375002-5.322919-1.531251-2.916669-1.531251-6.19792.0-3.09896 1.348959-5.432294 1.385417-2.333335 3.208335-3.427085 1.822918-1.130209 4.302085-1.713543-3.098959-2.260418-4.666668-4.921877-1.56771-2.66146-1.56771-5.76042.0-5.322919 4.484378-8.640629 4.484377-3.354168 10.901046-3.354168 5.395836.0 9.333338 2.515626t3.937502 6.088545q0 2.114584-1.494792 3.463543-1.494793 1.348959-3.427085 1.348959-1.895834.0-2.843752-.984375-.947917-1.020834-1.859376-3.718752-.838542-2.552085-2.078125-3.609377-1.239584-1.057292-3.463544-1.057292-2.296876.0-3.937502 1.276042-1.604167 1.276043-1.604167 3.062502.0 2.041667 1.567709 3.682293 1.531251 1.640626 7.473962 5.432294 5.578128 3.572919 8.239587 5.76042 2.697918 2.151043 4.229169 5.140627 1.567709 2.989585 1.567709 6.453128.0 4.411461-2.078126 7.218754-2.078126 2.807293-6.270836 4.010418zm1.166667-7.000003q0-3.682293-6.234378-8.531254-6.19792-4.885419-9.187505-4.885419-1.385417.0-2.661459 1.09375-1.239584 1.057293-1.239584 2.515627.0 3.463543 6.307295 8.421879 6.343753 4.958335 9.260421 4.958335 1.53125.0 2.625001-1.057292 1.130209-1.057292 1.130209-2.515626z" fill="#0"/></svg><span class=fs-5>&copy; 2022 Qnarre</span></a><ul class="list-unstyled small text-muted"><li class=mb-2>Software is our passion.</li></ul></div></div></div></footer><script src=../../js/bootstrap.bundle.min.js></script>
<script src=../../js/script.min.js></script></body></html>